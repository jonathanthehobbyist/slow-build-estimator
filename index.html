<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interior Design Estimator</title>
    <script src="conversation-flow.js"></script>
    <script src="pricing-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS (you'll get this from EmailJS dashboard)
        emailjs.init('WDXkQzVjEd5RcRLZ0'); // Replace with your actual public key
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700&family=IBM+Plex+Sans:ital,wght@0,400;0,500;0,600;0,700&&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
        /* Font Families */
        --font-serif: 'IBM Plex Mono', 'Times New Roman', serif;
        --font-sans: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

        /* Accents */
         --accent-rusty: #DE7D60;

        /* Font Sizes */
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;

        /* Font Weights */
        --font-normal: 400;
        --font-medium: 500;
        --font-semibold: 600;
        --font-bold: 700;

        /* Line Heights */
        --leading-tight: 1.25;
        --leading-normal: 1.5;
        --leading-relaxed: 1.6;
        --leading-loose: 1.75;

        /* Primary Colors */
        --primary-50: #eff6ff;
        --primary-100: #dbeafe;
        --primary-500: #3b82f6;
        --primary-600: #2563eb;
        --primary-700: #1d4ed8;

        /* Neutral Colors (Claude-inspired) */
        --neutral-50: #f9f9fa;
        --neutral-100: #f1efef;
        --neutral-200: #e6e4e2;
        --neutral-300: #d2cfcc;
        --neutral-400: #a09c98;
        --neutral-500: #5a5652;
        --neutral-600: #6b6b6b;
        --neutral-700: #3d3936;
        --neutral-800: #2d2d2d;
        --neutral-900: #1a1816;

        /* Semantic Colors */
        --success-50: #f0fdf4;
        --success-500: #22c55e;
        --success-600: #16a34a;

        --warning-50: #fffbeb;
        --warning-500: #f59e0b;
        --warning-600: #d97706;

        --error-50: #fef2f2;
        --error-500: #ef4444;
        --error-600: #dc2626;

        /* Application-Specific Colors */
        --background: var(--neutral-50);
        --white: #ffffff;
        --surface: var(--neutral-100);
        --surface-hover: var(--neutral-200);

        /* Text Colors */
        --text-primary: var(--neutral-800);
        --text-secondary: var(--neutral-600);
        --text-tertiary: var(--neutral-500);
        --text-inverse: #ffffff;

        /* Border Colors */
        --border-light: var(--neutral-200);
        --border-medium: var(--neutral-300);
        --border-strong: var(--neutral-400);

        /* Message Bubble Colors */
        --message-system-bg: var(--neutral-100);
        --message-system-text: var(--text-primary);
        --message-system-border: var(--border-light);

        --message-user-bg: var(--neutral-100);
        --message-user-text: var(--text-inverse);

        /* Button Colors */
        --button-primary-bg: var(--primary-600);
        --button-primary-hover: var(--primary-700);
        --button-primary-text: var(--text-inverse);

        --button-secondary-bg: var(--surface);
        --button-secondary-hover: var(--surface-hover);
        --button-secondary-text: var(--text-primary);
        --button-secondary-border: var(--primary-500);

        /* Progress Bar Colors */
        --progress-bg: var(--neutral-200);
        --progress-fill: linear-gradient(90deg, var(--success-500) 0%, var(--success-600) 100%);

        /* Cost Panel Colors */
        --cost-total-bg: var(--neutral-100);
        --cost-item-border: var(--border-light);

        /* Gallery Colors */
        --gallery-card-bg: var(--surface);
        --gallery-card-border: var(--border-light);
        --gallery-card-hover-border: var(--primary-500);
        --gallery-card-selected-bg: var(--primary-50);
        --gallery-card-selected-border: var(--primary-500);

        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

        /* Spacing System */
        --space-xs: 0.25rem;
        --space-sm: 0.5rem;
        --space-md: 1rem;
        --space-lg: 1.5rem;
        --space-xl: 2rem;
        --space-2xl: 3rem;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 18px;
        --radius-full: 50%;
        }


        body {
            font-family: var(--font-sans);
            background-color: var(--background);
            color: var(--text-primary);
            line-height: var(--leading-relaxed);
            font-size: var(--text-base);
            font-weight: var(--font-normal);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Mobile-first layout */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
        }

        /* Conversation Panel */
        .conversation-panel {
            background: var(--surface);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            min-height: 400px;
            max-height: 85vh;
        }

        .conversation-header,
        .cost-header {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-lg);
            color: var(--text-primary);
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
        }



        .conversation-flow {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: calc(85vh - 140px);
        }

        /* Gallery mode - full height when input options are hidden */
        .conversation-flow.gallery-mode {
            max-height: calc(85vh - 60px); /* Only account for header */
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .message.system {
            align-items: flex-start;
        }

        .message.user {
            align-items: flex-end;
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.system .message-bubble {
            background: transparent; /* No background for system messages */
            color: var(--message-system-text);
            border: none;

            /* Serif for system responses - more conversational */
            font-family: var(--font-serif);
            font-size: var(--text-xl);
            line-height: var(--leading-relaxed);
            font-weight: var(--font-normal);

            /* Full width with padding */
            width: 100%;
            max-width: none;
            padding: var(--space-md) 0;
            border-radius: 0;
        }

        .message.user .message-bubble {
            background: var(--neutral-100);
            color: var(--text-primary);
            border: 1px solid var(--border-light);

            /* Sans-serif for user responses - more direct */
            font-family: var(--font-sans);
            font-size: var(--text-base);
            line-height: var(--leading-normal);
            font-weight: var(--font-);

            /* Full width with subtle background */
            width: 100%;
            max-width: none;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-top: var(--space-sm);            

        }

        .message-user .message-image {
            margin-right: auto;
        }

        .message-system .message-image {
            margin-right: auto;
        }

        .user-image {
            max-width: 150px;
            max-height: 100px;
        }

        .message-image {
            max-width: 120px;
            max-height: 80px;
            border-radius: 6px;
            margin: 0.5rem 0;
            object-fit: cover;
            border: 1px solid #ddd;
            display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Email input container */
        .email-input-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Email input field */
        .email-input {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            font-weight: var(--font-normal);
            padding: var(--space-md);
            border: 2px solid var(--primary-500);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .email-input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .email-input.error {
            border-color: #e74c3c;
        }

        .email-input::placeholder {
            color: var(--text-tertiary);
            font-style: italic;
        }

        /* Email submit button */
        .email-submit-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .email-submit-button:hover:not(:disabled) {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        .email-submit-button:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Email error message */
        .email-error-message,
        .number-input-error {
            font-family: var(--font-sans);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--error-500);
            margin-top: var(--space-xs);
        }

        .email-error-message.show {
            display: block;
        }

        /* Multi-select button states */

        .multi-select-button {
            background-color: white !important;
            color: #2196f3 !important;
            border: 2px solid #2196f3 !important;
            transition: all 0.3s ease;
        }

        .multi-select-button.selected {
            background-color: #2196f3 !important;
            color: white !important;
        }

        .multi-select-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .multi-select-button {
            transition: all 0.3s ease;
        }

        .multi-select-button.selected {
            background-color: #2196f3 !important;
            color: white !important;
        }

        /* Multi-select gallery card base styles */
        .multi-select-gallery-card {
            cursor: pointer;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            transition: all 0.3s ease;
            position: relative;
        }

        .multi-select-gallery-card:hover {
            border-color: #2196f3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Multi-select gallery card selected state */
        .multi-select-gallery-card.selected {
            border-color: #2196f3 !important;
            background-color: #f0f7ff !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2) !important;
        }

        /* Multi-select gallery card image */
        .multi-select-gallery-card .card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        /* Multi-select gallery card content */
        .multi-select-gallery-card .card-content {
            padding: 0.75rem;
        }

        .multi-select-gallery-card .card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: #2c3e50;
        }

        .multi-select-gallery-card .card-description {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.3;
        }

        /* Selection checkmark for multi-select */
        .multi-select-gallery-card .selection-checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
        }

        /* Multi-select gallery container */
        .multi-select-gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            width: 100%;
            margin-bottom: 1.5rem;
        }

        /* Multi-select gallery overlay */
        .multi-select-gallery-overlay {
            width: 100%;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .multi-select-gallery-instructions {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-base);
            color: var(--text-primary);
            margin-bottom: var(--space-lg);
        }

        /* Continue button styles */
        .continue-button,
        .email-submit-button {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-base);
            padding: var(--space-md) var(--space-xl);
            background-color: var(--success-600);
            color: var(--text-inverse);
            border: none;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }

        .continue-button:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        .continue-button:enabled {
            background-color: #4CAF50;
            color: white;
        }

        .continue-button:enabled:hover {
            background-color: var(--success-500);
            transform: translateY(-1px);
        }

        /* Single-column gallery container */
        .gallery-container-single {
            display: grid !important;
            grid-template-columns: 1fr !important;  /* Force single column */
            gap: 1rem !important;
            width: 100% !important;
            max-width: 500px !important;  /* Limit width for better appearance */
            margin: 0 auto !important;    /* Center the column */
        }

        /* Make cards full width and taller in single-column */
        .gallery-container-single .gallery-card {
            width: 100% !important;
            max-width: none !important;
            min-height: 300px !important;  /* ‚Üê Make cards taller */
        }

        /* Much larger images for single-column */
        .gallery-container-single .gallery-card img {
            height: 240px !important;  /* ‚Üê Increased from 200px */
            width: 100% !important;
        }

        /* More spacious content padding */
        .gallery-container-single .gallery-card .card-content {
            padding: 1.5rem !important;  /* ‚Üê More padding */
            flex: 1;  /* ‚Üê Take up remaining space */
        }

        /* Larger text for single-column cards */
        .gallery-container-single .gallery-card .card-title {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            line-height: var(--leading-tight);
        }

        .gallery-container-single .gallery-card .card-description {
            font-family: var(--font-sans);
            font-weight: var(--font-normal);
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            line-height: var(--leading-normal);
        }

        /* Gallery card selection state */
        .gallery-card {
            transition: all 0.3s ease;
            position: relative;

            background: var(--gallery-card-bg);
            border: 2px solid var(--gallery-card-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        .gallery-card:hover {
            border-color: var(--gallery-card-hover-border);
            box-shadow: var(--shadow-md);
        }

        .gallery-card.selected {
            background: var(--gallery-card-selected-bg);
            border-color: var(--gallery-card-selected-border);
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2) !important;
        }

        /* Selection checkmark */
        .selection-checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .input-options {
            padding: 1rem;
            border-top: 1px solid #e5e5e5;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            overflow-y: auto;
            max-height: 40vh;
        }

        .option-button {
            font-family: var(--font-sans);
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            padding: var(--space-sm) var(--space-lg);
            border: 2px solid var(--button-secondary-border);
            background: var(--button-secondary-bg);
            color: var(--button-secondary-text);
            border-radius: var(--radius-xl);
            transition: all 0.2s ease;
        }

        .option-button:hover {
            background: var(--button-primary-bg);
            color: var(--button-primary-text);
            border-color: var(--button-primary-bg);
        }

        .option-button.selected {
            background: var(--button-primary-bg);
            color: var(--button-primary-text);
            border-color: var(--button-primary-bg);
        }

        /* Cost Panel */
        .cost-panel {
            background: var(--white);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            min-height: 300px;
            max-height: 85vh;
        }

        /*.cost-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e5e5;
            font-weight: 600;
            color: #2c3e50;
        }*/

        .cost-items {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: calc(85vh - 200px);
        }

        .cost-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--cost-item-border);
        }

        .cost-item:last-child {
            border-bottom: none;
        }

        .cost-item-name {
            font-family: var(--font-sans);
            font-weight: var(--font-normal);
            font-size: var(--text-sm);
            color: var(--text-primary);
            line-height: var(--leading-normal);
            flex: 1;
        }

        .cost-item-price {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
            color: var(--text-primary);
        }

        .total-section {
            padding: 1rem;
            background: var(--cost-total-bg);
            border-top: 2px solid var(--border-medium);
        }

        .total-range {
            display: flex;
            justify-content: between;
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-lg);
            color: var(--text-primary);
        }

        .range-display {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-xl);
            color: var(--text-inverse);
            text-align: center;
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-xl);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-top: var(--space-sm);
        }

        /* Custom scrollbar styling */
        .conversation-flow::-webkit-scrollbar,
        .cost-items::-webkit-scrollbar,
        .input-options::-webkit-scrollbar {
            width: 6px;
        }

        .conversation-flow::-webkit-scrollbar-track,
        .cost-items::-webkit-scrollbar-track,
        .input-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .conversation-flow::-webkit-scrollbar-thumb,
        .cost-items::-webkit-scrollbar-thumb,
        .input-options::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .conversation-flow::-webkit-scrollbar-thumb:hover,
        .cost-items::-webkit-scrollbar-thumb:hover,
        .input-options::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }


        .progress-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            border: none;
            padding: 0;
            z-index: 10;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent-rusty); /* Your rust color #DE7D60 */
            border-radius: 0;
            transition: width 0.6s ease-out;
            width: 0%;
        }

        .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
          border-radius: 4px;
          transition: width 0.6s ease-out;
          width: 0%;
        }

        .progress-text {
          font-family: var(--font-sans);
          font-weight: var(--font-medium);
          font-size: var(--text-sm);
          color: var(--text-secondary);
          text-align: center;
        }

        /* Animated progress fill */
        .progress-fill.animate {
          background: linear-gradient(90deg, #4CAF50 0%, #45a049 50%, #4CAF50 100%);
          background-size: 200% 100%;
          animation: progressShimmer 1.5s ease-out;
        }

        @keyframes progressShimmer {
          0% { background-position: -200% 0; }
          100% { background-position: 200% 0; }
        }
        /* Responsive adjustments */
        @media (max-height: 600px) {
            .conversation-panel,
            .cost-panel {
                max-height: 90vh;
            }
            
            .conversation-flow {
                max-height: calc(90vh - 140px);
            }
            
            .cost-items {
                max-height: calc(90vh - 200px);
            }
        }

        /* Desktop layout */
        @media (min-width: 768px) {

            .main-content {
                flex-direction: row; /* Keep side by side */
                gap: 0;
                padding: 0;
            }

            .conversation-header,
            .cost-header {
                font-size: var(--text-base);
                padding: var(--space-md);
            }

            .message.system .message-bubble,
            .message.user .message-bubble {
                padding: var(--space-sm) var(--space-md);
            }

            .range-display {
                font-size: var(--text-lg);
                padding: var(--space-sm) var(--space-lg);
            }

            .conversation-panel {
                border-radius: 0;
                box-shadow: none;
                border-right: 1px solid var(--border-light);
                position: relative;
            }

            .cost-panel {
                border-radius: 0;
                box-shadow: none;
                position: static;
            }

            .message-image {
                max-width: 300px;
            }
        }

        /* Large desktop */
        @media (min-width: 1024px) {
            .conversation-panel {
                flex: 3;
            }

            .cost-panel {
                flex: 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <!-- Conversation Panel -->
            <div class="conversation-panel">
                <div class="conversation-header">
                    Interior Design Consultation
                </div>

                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                  </div>
                  <div class="progress-text" id="progressText">Step 1 of 12</div>
                </div>
                
                <div class="conversation-flow" id="conversationFlow">
                    <!-- Messages will be dynamically added here -->
                </div>

                <div class="input-options" id="inputOptions">
                 <!-- Options loaded dynamically -->
                </div>
            </div>

            <!-- Cost Panel -->
            <div class="cost-panel">
                <div class="cost-header">
                    Project Estimate
                </div>
                
                <div class="cost-items" id="costItems">
                    <div class="cost-item">
                        <span class="cost-item-name">Initial Consultation</span>
                        <span class="cost-item-price">$150</span>
                    </div>
                    <!-- Cost items will be dynamically added here -->
                </div>

                <div class="total-section">
                    <div class="total-range">
                        <span>Estimated Total:</span>
                    </div>
                    <div class="range-display" id="totalRange">
                        $150 - $300
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple state management
        let conversationState = {
            currentStep: 'initial',
            sessionData: {},
            costItems: []
        };

        function showLoadingState() {
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '<div style="text-align: center; color: #666;">Loading options...</div>';
        }

        // Might be extra, remove later

        /* document.addEventListener('DOMContentLoaded', function() {
            showLoadingState();
            setTimeout(initializeConversation, 100);
        }); */

        // Add message to conversation
        function addMessage(content, type = 'system', imageUrl = null) {

            console.log('addMessage called:', content, type);

            const conversationFlow = document.getElementById('conversationFlow');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let messageHTML = `<div class="message-bubble">${content}</div>`;
            
            if (imageUrl) {
                messageHTML += `<img src="${imageUrl}" alt="${content}" class="message-image ${type}-image">`;
            }
            
            messageDiv.innerHTML = messageHTML;
            conversationFlow.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => { 
                conversationFlow.scrollTop = conversationFlow.scrollHeight;
            }, 100);
        }

        // Handle option selection
        function selectOption(option) {

            //disable all buttons immediately
            disableAllButtons();

            // Add user message
            addMessage(option, 'user');
            
            // Store selection in sessionData
            conversationState.sessionData[conversationState.currentStep] = option;
            
            // Update buttons
            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Debug logging
            console.log('Selected:', option);
            console.log('Current step:', conversationState.currentStep);
            console.log('Session data:', conversationState.sessionData);

            setTimeout(updateProgress, 100); // Call for immediate feedback
            
            // Progress conversation
            setTimeout(() => {
                progressConversation(option);
            }, 500);
        }

        function disableAllButtons() {

            // Prevents unintentional double-clicks

            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            });
        }

        function updateSelectedButton(clickedButton) {
            // Highlights selected while keeping other disabled
            // Visual feedback
            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.classList.remove('selected'));

            if (clickedButton) {
                clickedButton.classList.add('selected');
                clickedButton.style.opacity = '1'; // make selected button fully visible
            }
        }

        // Conversation, question & statement handlers

        function displayStatement(statementText, callback) {
          if (statementText) {
            addMessage(statementText, 'system');
            setTimeout(callback, window.CONVERSATION_TIMING.statementDelay);
          } else {
            callback(); // No statement, proceed immediately
          }
        }

        function updateContinueInput() {
          const inputOptions = document.getElementById('inputOptions');
          inputOptions.innerHTML = '';
          
          const continueButton = document.createElement('button');
          continueButton.className = 'option-button';
          continueButton.textContent = 'Continue';
          continueButton.style.backgroundColor = '#4CAF50';
          continueButton.onclick = () => selectOption('continue');
          
          inputOptions.appendChild(continueButton);

          // Flash to indicate continue button is available
          setTimeout(() => flashInputOptions(), 50);
        }

        function progressConversation(lastSelection) { 
            console.log('üöÄ progressConversation called with:', lastSelection);  // ‚Üê Add this
            console.log('üöÄ typeof lastSelection:', typeof lastSelection);  // ‚Üê Add this
            console.log('üöÄ Array.isArray(lastSelection):', Array.isArray(lastSelection));  // ‚Üê Add this
    

            // Get line items for the current step
            if (window.ConversationFlowHelper) {
                console.log('üöÄ ConversationFlowHelper exists, calling getLineItemsForStep');  // ‚Üê Add this
                const lineItems = window.ConversationFlowHelper.getLineItemsForStep(
                    conversationState.currentStep, 
                    lastSelection
                );

                // DEBUG: Check if line items are being generated
                console.log('Current step:', conversationState.currentStep);
                console.log('Last selection:', lastSelection);
                console.log('Generated line items:', lineItems);
                console.log('Line items length:', lineItems.length);
                
                // Add line items to cost estimate
                lineItems.forEach(item => {
                    console.log('Adding line item:', item);
                    conversationState.costItems.push(item);
                });
                console.log('Total cost items now:', conversationState.costItems);
            }

            const currentStepConfig = window.CONVERSATION_FLOW[conversationState.currentStep];
            if(currentStepConfig && currentStepConfig.responseLogic) {
                const responseMessage = currentStepConfig.responseLogic(lastSelection, conversationState.sessionData);
                if(responseMessage) {
                    setTimeout(() => {
                        addMessage(responseMessage, 'system');
                    }, 800) // delay to feel more natural

                }
            }
            
            // Get next step
            let nextStep;
            if (window.ConversationFlowHelper) {
                nextStep = window.ConversationFlowHelper.getNextStep(
                    conversationState.currentStep, 
                    lastSelection, 
                    conversationState.sessionData
                );
            }
            
            if (nextStep === 'complete') {
                addMessage("Thank you! Your estimate is complete. You can review the details on the right.");
                document.getElementById('inputOptions').innerHTML = '';
                updateCostEstimate();
                return;
            }
            
            // Check if next step exists
            if (!nextStep || !window.CONVERSATION_FLOW[nextStep]) {
                console.error('Invalid next step:', nextStep);
                addMessage("Sorry, there was an issue. Let me restart.");
                conversationState.currentStep = 'initial';
                initializeConversation();
                return;
            }
            
            // Update current step
            conversationState.currentStep = nextStep;
            updateProgress(); // calls the progress update

            // Determine if question also has a response
            const hasResponse = currentStepConfig && currentStepConfig.responseLogic;
            const nextQuestionDelay = hasResponse ? 1500 : 100; //Wait longer if we show a response
            
            // Get next step configuration
            const stepConfig = window.CONVERSATION_FLOW[nextStep];
            if (stepConfig) {
                setTimeout(() => {
                // handle statement display and timing
                if (stepConfig.statementTiming === 'before') {
                    // statement first
                    displayStatement(stepConfig.statement, () => {
                        /*if (stepConfig.question) {
                            addMessage(stepConfig.question);
                        }*/

                        if (stepConfig.question) {
                            let questionText;
                            if (typeof stepConfig.question === 'function') {
                                questionText = stepConfig.question();  // ‚Üê Call the function
                            } else {
                                questionText = stepConfig.question;    // ‚Üê Use string directly
                            }
                            addMessage(questionText);
                        }
                        setTimeout(() => showInputs(stepConfig), window.CONVERSATION_TIMING.statementDelay);
                    });
                } else if (stepConfig.statementTiming === 'after') {

                    // Question first, then statement
                    /*if (stepConfig.question) {
                        addMessage(stepConfig.question);
                    }*/

                    if (stepConfig.question) {
                        let questionText;
                        if (typeof stepConfig.question === 'function') {
                            questionText = stepConfig.question();  // ‚Üê Call the function
                        } else {
                            questionText = stepConfig.question;    // ‚Üê Use string directly
                        }
                        addMessage(questionText);
                    }

                    setTimeout(() => {
                        showInputs(stepConfig);
                        displayStatement(stepConfig.statement, () => {});
                    }, window.CONVERSATION_TIMING.statementDelay);
                } else if (stepConfig.inputType === 'continue') {
                    // Information-only step
                    displayStatement(stepConfig.statement, () => {
                        setTimeout(() => updateContinueInput(), window.CONVERSATION_TIMING.continueButtonDelay);
                    });
                } else {
                    // No statement, just question
                    /*if (stepConfig.question) {
                        addMessage(stepConfig.question);
                    }*/
                    if (stepConfig.question) {
                        let questionText;
                        if (typeof stepConfig.question === 'function') {
                            questionText = stepConfig.question();  // ‚Üê Call the function
                        } else {
                            questionText = stepConfig.question;    // ‚Üê Use string directly
                        }
                        addMessage(questionText);
                    }
                    setTimeout(() => showInputs(stepConfig), window.CONVERSATION_TIMING.statementDelay);
                }
              }, nextQuestionDelay);   
            }

                // removed
                /* addMessage(stepConfig.question);

                    // DEBUG: Log the step config
                    console.log('Step config:', stepConfig);
                    console.log('Input type:', stepConfig.inputType);
                    console.log('Has options:', !!stepConfig.options);
                
                // Handle different input types
                if (stepConfig.inputType === 'choice') {
                    updateInputOptions(stepConfig.options.map(option => ({
                        text: option,
                        value: option
                    })));
                } else if (stepConfig.inputType === 'number') {
                    updateNumberInput(stepConfig.validation);
                } else if (stepConfig.inputType === 'gallery') {
                    updateGalleryInput(stepConfig.options);
                }
            } */
            
            updateCostEstimate();
        }
            

        function showInputs(stepConfig) {
          if (stepConfig.inputType === 'choice') {
            updateInputOptions(stepConfig.options.map(option => ({
              text: option,
              value: option
            })));
          } else if (stepConfig.inputType === 'number') {
            updateNumberInput(stepConfig.validation);
          } else if (stepConfig.inputType === 'gallery') {
            updateGalleryInput(stepConfig.options);
          } else if (stepConfig.inputType === 'continue') {
            updateContinueInput();
          } else if (stepConfig.inputType === 'multiSelect') {
            updateMultiSelectInput(stepConfig.options);
          } else if (stepConfig.inputType === 'multiSelectGallery') {
            updateMultiSelectGallery(stepConfig.options);
          } else if (stepConfig.inputType === 'email') {
            updateEmailInput(stepConfig.validation);
          }
        }

        /*------------------ GALLERY -------------------*/

        function createGalleryCard(option) { 
            // individual gallery card
            // returns clickable element that triggers selection

            const card = document.createElement('div');
            card.className = 'gallery-card';
            card.style.cursor = 'pointer';
            card.style.border = '2px solid #e5e5e5';
            card.style.borderRadius = '8px';
            card.style.overflow = 'hidden';
            card.style.transition = 'all 0.3s ease';
            card.style.backgroundColor = 'white';

            //Hover effects
            card.addEventListener('mouseenter', () => {
                card.style.borderColor = '#2196f3';
                card.style.transform = 'translateY(-2px)';
                card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            });

            card.addEventListener('mouseleave', () => {
                if (!card.classList.contains('selected')) {
                    card.style.borderColor = '#e5e5e5';
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = 'none';
                }

            });

            const image = document.createElement('img');
            image.src = option.thumbnail || option.image;
            image.alt = option.name;
            image.style.width = '100%';
            image.style.width = '100%';
            image.style.height = '120px';
            image.style.objectFit = 'cover';
            image.style.display = 'block';

            const content = document.createElement('div');
            content.style.padding = '0.75rem';

            const title = document.createElement('div');
            title.textContent = option.name;
            title.style.fontWeight = '600';
            title.style.fontSize = '0.9rem';
            title.style.marginBottom = '0.25rem';
            title.style.color = '#2c3e50';

            const description = document.createElement('div');
            description.textContent = option.description || '';
            description.style.fontSize = '0.8rem';
            description.style.color = '#666';
            description.style.lineHeight = '1.3';

            content.appendChild(title);
            if (option.description) {
                content.appendChild(description);
            }

            card.appendChild(image);
            card.appendChild(content)

            //click handler
            card.onclick = () => selectGalleryOption(option.name, card);

            return card;

        }

        function updateGalleryInput(options) {

            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            inputOptions.style.display = 'none';

            // Enable gallery mode for full height
            //const conversationFlow = document.getElementById('inputOptions');
            

            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.add('gallery-mode');

            const galleryOverlay = document.createElement('div');
            galleryOverlay.id = 'galleryOverlay';
            galleryOverlay.style.width = '100%';
            galleryOverlay.style.padding = '1rem';
            galleryOverlay.style.backgroundColor = '#f8f9ff';
            galleryOverlay.style.borderRadius = '8px';
            galleryOverlay.style.marginTop = '1rem';

            // Ensure the container can expand
            //inputOptions.style.display = 'block'; // Override any flex settings
            //inputOptions.style.width = '100%';

            const galleryContainer = document.createElement('div');
            galleryContainer.style.display = 'grid';
            //galleryContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(180px, 1fr))';
            galleryContainer.style.gap = '1rem';
            galleryContainer.style.padding = '0 .5rem 0';
            galleryContainer.style.width = '100%';

            //check for single column layout
            const currentStep = window.CONVERSATION_FLOW[conversationState.currentStep];
            if (currentStep && currentStep.layout === 'single-column') {
                console.log('üé® Using single-column layout');
                galleryContainer.className = 'gallery-container-single';
                // CSS classes handle grid layout
            } else {
                console.log('üé® Using default multi-column layout');
                galleryContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(180px, 1fr))';
            }

            options.forEach(option => {
                const card = createGalleryCard(option);
                galleryContainer.appendChild(card);
            });

            // Add instructions
            const instructions = document.createElement('div');

            // Current step's key name
            const currentStepStr = conversationState.currentStep
                .replace(/_/g, ' ')                         // underscores ‚Üí spaces
                .replace(/\b\w/g, l => l.toUpperCase());    // capitalize each word

            instructions.textContent = `Select 1 choice for ${currentStepStr}`  
            //'Select a material option below';
            instructions.style.marginBottom = '1rem';
            instructions.style.fontWeight = '600';
            instructions.style.color = '#2c3e50';

            galleryOverlay.appendChild(instructions);
            galleryOverlay.appendChild(galleryContainer);
            conversationFlow.appendChild(galleryOverlay);

            //scroll to gallery
            setTimeout(() => {
                galleryOverlay.scrollIntoView({ behavior: 'smooth' });
                flashInputOptions(); // Flash the input area
            }, 100);

            //inputOptions.appendChild(galleryContainer);
            //setTimeout(() => flashInputOptions(), 50);

            /*updateInputOptions(options.map(option => ({
                text: option.name || option,
                value: option.name || option
            })));*/
        }

        function selectGalleryOption(optionName, cardElement) {
            //handles selection of gallery element with visual feedback
            //highlights selected card and proceeds with conversation

            // DEBUG: Check what we're getting
            console.log('selectGalleryOption called with:', optionName);
            console.log('Type of optionName:', typeof optionName);

            // Find the full option object with img URL form config
            const currentStep = window.CONVERSATION_FLOW[conversationState.currentStep];
            const fullOption = currentStep.options.find(opt => opt.name === optionName);

            //store name and image systematically
            window.tempGallerySelection = {
                name: optionName,
                image: fullOption ? fullOption.image : null,
                thumbnail: fullOption ? fullOption.thumbnail : null,
                description: fullOption ? fullOption.description : null
            };

            console.log('Stored full option:', window.tempGallerySelection);

            // Remove previous selections
            document.querySelectorAll('.gallery-card').forEach(card => {
                card.classList.remove('selected');
                card.style.borderColor = 'e5e5e5';
                card.style.transform = 'translateY(0)';
                card.style.boxShadow = 'none';
                card.style.backgroundColor = 'white';
            });

            //highlight selected card
            cardElement.classList.add('selected');
            cardElement.style.borderColor = '#2196f3';
            cardElement.style.backgroundColor = '#f8f9ff';
            cardElement.style.transform = 'translateY(-2px)';
            cardElement.style.boxShadow = '0 4px 12px rgba(33, 150, 243, 0.2)';

            //disable all cards to prevent double-click
            /* document.querySelectorAll('.gallery-card').forEach(card => {
                card.style.pointerEvents = 'none';
                if (!card.classList.contains('selected')) {
                    card.style.opacity = '0.6';
                }
            });*/

            //proceed with selection
            showGalleryConfirmButton(optionName);
        }

        function showGalleryConfirmButton(chosenOption) {

            console.log('showGalleryConfirmButton called with:', chosenOption);
            console.log('Type of chosenOption:', typeof chosenOption);

            // Shows confirm button for gallery selection
            // Allows user to confirm choice before proceeding

            // Remove existin confirm button if any
            const existingButton = document.getElementById('galleryConfirmButton');
            if (existingButton) {
                existingButton.remove();
            }

            const galleryOverlay = document.getElementById('galleryOverlay');
            if (!galleryOverlay) return;

            const confirmContainer = document.createElement('div');
            confirmContainer.id = 'galleryConfirmButton';
            confirmContainer.style.marginTop = '1.5rem';
            confirmContainer.style.textAlign = 'center';
            confirmContainer.style.padding = '1rem';
            confirmContainer.style.backgroundColor = 'white';
            confirmContainer.style.borderRadius = '8px';
            confirmContainer.style.borderColor = '2px solid #2196f3';

            const selectionText = document.createElement('div');

            // DEBUG: Test different ways of setting the text
            const testText = 'You selected: ' + chosenOption;
            console.log('testText variable:', testText);

            selectionText.textContent = 'You selected:' + chosenOption;
            console.log('selectionText.textContent after setting:', selectionText.textContent);
            selectionText.style.marginBottom = '1rem';
            selectionText.style.fontWeight = '600';
            selectionText.style.color = '#2c3e50';

            const confirmButton = document.createElement('button');
            confirmButton.className = 'option-button';
            confirmButton.textContent = 'Confirm Selection';
            confirmButton.style.backgroundColor = '#4caf50';
            confirmButton.style.color = 'white';
            confirmButton.style.border = 'none';
            confirmButton.style.padding = '0.75rem 2rem';
            confirmButton.style.fontSize = '1rem';
            confirmButton.style.fontWeight = '600';

            confirmButton.onclick = () => confirmGallerySelection();

            confirmContainer.appendChild(selectionText);
            confirmContainer.appendChild(confirmButton);
            galleryOverlay.appendChild(confirmContainer);

            // Scroll to confirm button
            setTimeout(() => {
                confirmButton.scrollIntoView({ behavior: 'smooth', block: 'center'});
            }, 100);
        }

        function confirmGallerySelection() {
            // Finallizes gallery selection and proceeds with conversation
            // Cleans up Gallery overlay and restores normal input area

            const selectedOptionData = window.tempGallerySelection;
            if (!selectedOptionData || !selectedOptionData.name) return;

            console.log('Confirming selection:', selectedOptionData);

            // Remove gallery overlay
            const galleryOverlay = document.getElementById('galleryOverlay');
            if (galleryOverlay) {
                galleryOverlay.remove();
            }

            // Restore normal conversation-flow height
            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.remove('gallery-mode');

            // Restore input options area
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.style.display = 'flex';

            // Add user message with image from stored data
            const imageUrl = selectedOptionData.thumbnail || selectOptionData.image;
            addMessage(selectedOptionData.name, 'user', imageUrl);

            // Store selection in session data (just the name for flow logic)
            conversationState.sessionData[conversationState.currentStep] = selectedOptionData.name;

            // Store complete option data for future use
            conversationState.sessionData[conversationState.currentStep + '_fullData'] = selectedOptionData;

            // Clear temp selection
            delete window.tempGallerySelection;

            // Proceed with the selection
            //selectOption(selectedOption);

            // Continue conversation
            setTimeout(() => {
                progressConversation(selectedOptionData.name);
            }, 500);

        }

        function updateMultiSelectInput(options) {
            // Creates multi-select pill button with confirm workflow
            // Allows multiple selections before proceeding

            console.log('updateMultiSelectInput called with:', options);
            console.log('Options array contents:', JSON.stringify(options, null, 2));

            const inputOptions = document.getElementById('inputOptions');
            console.log('inputOptions element:', inputOptions);
            console.log('inputOptions style object:', inputOptions.style);

            if (!inputOptions) {
                console.error('inputOptions element not found!');
                return;
            }

            // Clear the content
            try {
                inputOptions.innerHTML = '';
                console.log('innerHTML cleared successfully');
            } catch (error) {
                console.error('Error clearing innerHTML:', error);
                return;
            }

            // Try to access the style property that's failing
            try {
                inputOptions.style.display = 'flex';
                console.log('Style.display set successfully');
            } catch (error) {
                console.error('Error setting style.display:', error);
                return;
            }

            inputOptions.innerHTML = '';

            // Initialize selection tracking
            window.tempMultiSelections = [];

            if (!inputOptions) {
                console.error('inputOptions element not found!');
                return;
            }

            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexWrap = 'wrap';
            container.style.gap = '0.5rem';
            container.style.marginBottom = '1rem';

            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button multi-select-button';
                button.textContent = option;
                button.onclick = () => toggleMultiSelect(option, button);
                container.appendChild(button);
            });

            // Add continue button (initially disabled)
            const continueButton = document.createElement('button');
            continueButton.id = 'multiSelectContinue';
            continueButton.className = 'option-button';
            continueButton.textContent = 'Continue';
            continueButton.disabled = true;
            continueButton.onclick = () => confirmMultiSelect();

            inputOptions.appendChild(container);
            inputOptions.appendChild(continueButton);

            setTimeout(() => flashInputOptions(), 50);

        }

        // needs to go before updateMultiSelectGallery

        function createMultiSelectGalleryCard(option) {
            // Creates gallery card for multi-select using CSS classes
            // Returns clickable card that can be selected/deselected

            const card = document.createElement('div');
            card.className = 'multi-select-gallery-card';

            const image = document.createElement('img');
            image.src = option.thumbnail || option.image;
            image.alt = option.name;
            image.className = 'card-image';

            const content = document.createElement('div');
            content.className = 'card-content';

            const title = document.createElement('div');
            title.textContent = option.name;
            title.className = 'card-title';

            const description = document.createElement('div');
            description.textContent = option.description || '';
            description.className = 'card-description';

            content.appendChild(title);
            if (option.description) {
                content.appendChild(description);
            }

            card.appendChild(image);
            card.appendChild(content);

            // click handler for multi-select
            card.onclick = () => toggleMultiSelectGallery(option, card);

            return card;
        }

        function updateMultiSelectGallery(options) {
            // creates multi select gallery with image cards and confirm workflow
            // Allows multiple image selections before proceeding

            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            inputOptions.style.display = 'none';

            // Initialize selection tracking
            window.tempMultiSelections = [];

            // Enable gallery mode for full height
            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.add('gallery-mode');

            const galleryOverlay = document.createElement('div');
            galleryOverlay.id = 'multiSelectGalleryOverlay';
            galleryOverlay.className = 'multi-select-gallery-overlay';
           

            const instructions = document.createElement('div');
            instructions.textContent = 'Choose all that apply';
            instructions.className = 'multi-select-gallery-instructions';

            const galleryContainer = document.createElement('div');
            galleryContainer.className = 'multi-select-gallery-container'

            options.forEach(option => {
                const card = createMultiSelectGalleryCard(option);
                galleryContainer.appendChild(card);
            });

            // Add continue button
            const continueButton = document.createElement('button');
            continueButton.id = 'multiSelectGalleryContinue';
            continueButton.className = 'option-button continue-button';
            continueButton.textContent = 'Continue';
            // continueButton style
            continueButton.disabled = true;
            //continueButton.onclick = () => confirmMultiSelectGallery();

            continueButton.onclick = () => {
                console.log('Continue button clicked!');  // ‚Üê Add this
                confirmMultiSelectGallery();
            };

            galleryOverlay.appendChild(instructions);
            galleryOverlay.appendChild(galleryContainer);
            galleryOverlay.appendChild(continueButton);
            conversationFlow.appendChild(galleryOverlay);



            setTimeout(() => {
                galleryOverlay.scrollIntoView({ behavior: 'smooth' });
                flashInputOptions();
            }, 100);
        }

        function toggleMultiSelect(option, buttonElement) {
            // Toggles selected state for multi-select pill buttons
            // Updates visual state and enables / disables continue button

            const index = window.tempMultiSelections.indexOf(option);

            if (index === -1) {
                // Add selection
                window.tempMultiSelections.push(option);
                buttonElement.classList.add('selected');

            } else {
                // Remove selection
                window.tempMultiSelections.splice(index, 1);
                buttonElement.classList.remove('selected');
            }

            updateMultiSelectContinueButton();

        }

        function toggleMultiSelectGallery(option, cardElement) {
            // Toggles selection state for multi-select gallery cards
            // Updates visual state and enables/disables continue button

            console.log('toggleMultiSelectGallery called with:', option.name);

            const index = window.tempMultiSelections.findIndex(item => item.name === option.name);

            if (index === -1) {
                // Add selection
                window.tempMultiSelections.push(option);
                cardElement.classList.add('selected');

                // Add checkmark
                addSelectionCheckmark(cardElement);

            } else {

                // Remove selection
                window.tempMultiSelections.splice(index, 1);
                cardElement.classList.remove('selected');
                /*cardElement.style.borderColor = '#e5e5e5';
                cardElement.style.backgroundColor = 'white';
                cardElement.style.transform = 'translateY(0)';
                cardElement.style.boxShadow = 'none';*/

                // remove checkmark
                removeSelectionCheckmark(cardElement);
            }
            console.log('About to call updateMultiSelectContinueButton');  // ‚Üê Add this
            updateMultiSelectContinueButton();
        }

        function updateMultiSelectContinueButton() {
            // Enables/disables continue button based on selections
            // Updates button styling and interaction state

            const continueButton = document.getElementById('multiSelectContinue') || document.getElementById('multiSelectGalleryContinue');

            if (continueButton) {
                if (window.tempMultiSelections.length > 0) {
                    continueButton.disabled = false;
                    continueButton.textContent = `Continue (${window.tempMultiSelections.length} selected)`;

                } else {
                    continueButton.disabled = true;
                    continueButton.textContent = 'Continue';

                }
            }
        }

        function addSelectionCheckmark(cardElement) {
            // Adds visual checkmark to selected gallery cards
            const checkmark = document.createElement('div');
            checkmark.className = 'selection-checkmark';
            checkmark.innerHTML = '‚úì';

            cardElement.appendChild(checkmark);

        }

        function removeSelectionCheckmark(cardElement) {
            // Removes visual checkmark from deselected gallery cards
            const checkmark = cardElement.querySelector('.selection-checkmark');
            if (checkmark) {
                checkmark.remove();
            }
        }

        function confirmMultiSelect() {
            // Finalizes the multi-select pill button functions
            // Proceeds with conversation using selected options

            if (!window.tempMultiSelections || window.tempMultiSelections.length === 0) return;

            console.log('Multi-select confirmed:', window.tempMultiSelections);

            // Add user message showing selections
            const selectionText = window.tempMultiSelections.join(', ');
            addMessage(selectionText, 'user');

            // Store selections in session data
            conversationState.sessionData[conversationState.currentStep] = window.tempMultiSelections;

            delete window.tempMultiSelections;

            // Continue conversation
            setTimeout(() => {
                progressConversation(selectionText);
            }, 500);
        }

        function confirmMultiSelectGallery() {
            // Finalizes multi-select gallery selections with images
            // Shows selected images in conversation and procceds

            console.log('üöÄ confirmMultiSelectGallery called!');  // ‚Üê Add this
            console.log('üöÄ tempMultiSelections:', window.tempMultiSelections);  // ‚Üê Add this

            //if (!window.tempMultiSelections || window.tempMultiSelections.length === 0 ) return;

            if (!window.tempMultiSelections || window.tempMultiSelections.length === 0 ) {
                console.log('üö® No selections, returning early');  // ‚Üê Add this
                return;
              }

            console.log('Multi-select gallery confirmed:', window.tempMultiSelections);

            // Remove Overlay gallery
            const galleryOverlay = document.getElementById('multiSelectGalleryOverlay');
            if (galleryOverlay) {
                galleryOverlay.remove();
            }

            // Restore normal conversation flow height
            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.remove('gallery-mode');

            // Restore input options area
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.style.display = 'flex';

            // Add user message for each selection with images
            window.tempMultiSelections.forEach(selection => {
                const imageUrl = selection.thumbnail || selection.image;
                const name = selection.name || selection;
                addMessage(name, 'user', imageUrl);
            });

            // Store selections in session data (just names for flow logic)
            const selectionNames = window.tempMultiSelections.map(item => item.name || item);
            conversationState.sessionData[conversationState.currentStep] = selectionNames;

            // Add this debug:
            console.log('Stored session data:', conversationState.sessionData);
            console.log('Current cost items:', conversationState.costItems);

            // Store complete selection data
            conversationState.sessionData[conversationState.currentStep + '_fullData'] = window.tempMultiSelections;

            // Clear temp selections
            delete window.tempMultiSelections;

            // Continue conversation

            console.log('üöÄ About to call progressConversation with:', selectionNames);  // ‚Üê Add this
            setTimeout(() => {
                progressConversation(selectionNames); // passing an array
            }, 500);

        }

        

        function updateNumberInput(validation) {

            // Creates a number input field with validation rules and error handling
            // Displays input field, submit button, and error message container


            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            
            const inputContainer = document.createElement('div');
            inputContainer.style.display = 'flex';
            inputContainer.style.gap = '0.5rem';
            inputContainer.style.alignItems = 'center';

            const inputRow = document.createElement('div');
            inputRow.style.display = 'flex';
            inputRow.style.gap = '0.5rem';
            inputRow.style.alignItems = 'center';
            
            const numberInput = document.createElement('input');
            numberInput.type = 'text';
            numberInput.placeholder = validation ? `${validation.min} - ${validation.max} sq ft` : 'Enter square footage';
            numberInput.style.padding = '0.5rem';
            numberInput.style.border = '2px solid #2196f3';
            numberInput.style.borderRadius = '8px';
            numberInput.style.fontSize = '1rem';
            numberInput.style.flex = '1';
            
            /* if (validation) {
                numberInput.min = validation.min;
                numberInput.max = validation.max;
            }*/

            // asked me to remove ^^
            
            const submitButton = document.createElement('button');
            submitButton.className = 'option-button';
            submitButton.textContent = 'Continue';
            submitButton.onclick = () => handleNumberSubmit(numberInput, validation);


            /*submitButton.onclick = () => {
                const value = numberInput.value;
                if (value && (!validation || (value >= validation.min && value <= validation.max))) {
                    selectOption(value);
                } else {
                    alert(`Please enter a number between ${validation.min} and ${validation.max}`);
                }
            };*/

            // asked me to remove ^^

            //error message
            const errorMessage = document.createElement('div');
            errorMessage.id = 'numberInputError';
            errorMessage.style.color = '#e74c3c';
            errorMessage.style.fontSize = '0.9rem';
            errorMessage.style.display = 'none';

            //realtime validation
            numberInput.addEventListener('input', () => clearNumberError());
            numberInput.addEventListener('keypress', (e) => handleNumberKeypress(e, numberInput, validation));
            
            /*inputContainer.appendChild(numberInput);
            inputContainer.appendChild(submitButton);
            inputOptions.appendChild(inputContainer);*/

            // asked me to remove ^^

            inputRow.appendChild(numberInput);
            inputRow.appendChild(submitButton);
            inputContainer.appendChild(inputRow);
            inputContainer.appendChild(errorMessage);
            inputOptions.appendChild(inputContainer);

            // Flash to indicate new input is available
            setTimeout(() => flashInputOptions(), 50);
            setTimeout(() => numberInput.focus(), 100);
            
            setTimeout(() => numberInput.focus(), 100);
        }

        function updateProgress() {
            const roomType = conversationState.sessionData.initial;
            const currentStep = conversationState.currentStep;

            if(!roomType) return;

            const progressInfo = window.ProgressCalculator.getProgressInfo(
                roomType,
                currentStep,
                conversationState.sessionData
            );

            // Update UI
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            if(progressFill && progressText) {
                // Animate progress bar
                progressFill.style.width = `${progressInfo.progressPercent}%`;

                // Update with dynamic info
                /*progressText.textContent = 
                    `Step ${progressInfo.currentStep} of ${progressInfo.totalSteps} ‚Ä¢ ${progressInfo.progressPercent}% Complete`;*/

                progressText.textContent = 
                    `${progressInfo.progressPercent}% Complete`;

                // Add completion styling
                if (progressInfo.isComplete) {
                    progressFill.classList.add('complete');
                    progressText.textContent = 'Complete!';
                }
            }

            // Debug info
            console.log('Dyanmic Progress', progressInfo);
        }

        /* ------- STYLE FUNCTIONS ------------*/

        function flashInputOptions() {
            // Highlights the input options area with 2 flashes when new options load
            // Provides visual feedback that new choices are available
            const inputOptions = document.getElementById('inputOptions');
            if (!inputOptions) return;
            
            const originalBackground = inputOptions.style.backgroundColor;
            const flashColor = '#e3f2fd'; // Light blue system color

            // Add CSS transition for smooth animation
            inputOptions.style.transition = 'background-color 300ms ease-in-out';
            
            let flashCount = 0;
            const maxFlashes = 2;
            
            function doFlash() {
                if (flashCount >= maxFlashes * 2) {
                    // Reset to original background
                    inputOptions.style.backgroundColor = originalBackground;
                    return;
                }
                
                // Alternate between flash color and original
                if (flashCount % 2 === 0) {
                    inputOptions.style.backgroundColor = flashColor;
                } else {
                    inputOptions.style.backgroundColor = originalBackground;
                }
                
                flashCount++;
                setTimeout(doFlash, 200); // 200ms per flash phase
            }
            
            doFlash();
        }

        /* ------- NUMBER INPUT FUNCTIONS ------------*/

        // added funtion
        function handleNumberSubmit(inputElement, validation) {

            // Validates user input and submits if valid, shows error if invalid
            // Checks for empty values, non-numeric characters, and range validation

            // Disable submit button to prevent double submission
            const submitButton = inputElement.parentElement.querySelector('.option-button');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.style.opacity = '0.6';
                submitButton.textContent = 'Thinking...';
            }

            const value = inputElement.value.trim();
            
            // Check if empty
            if (!value) {
                showNumberError('Please enter a value');
                return;
            }
            
            // Check if contains only digits
            if (!isValidNumber(value)) {
                showNumberError('Please enter only numbers');
                return;
            }
            
            const numValue = parseInt(value);
            
            // Check validation range
            if (validation && (numValue < validation.min || numValue > validation.max)) {
                showNumberError(`Please enter a number between ${validation.min} and ${validation.max}`);

                //Re-enable button on error
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                    submitButton.textContent = 'Continue';
                }

                return;
            }
            
            // All good, proceed
            selectOption(value);
        }

        function isValidNumber(value) {

            // Returns true if input contains only digits, commas, and spaces
            // Allows formatted numbers like "1,200" or "1 200" but rejects letters

            // Check if string contains only digits (and optionally spaces/commas)
            const digitPattern = /^[\d,\s]+$/;
            if (!digitPattern.test(value)) {
                return false;
            }
            
            // Remove commas and spaces, then check if it's a valid number
            const cleanValue = value.replace(/[,\s]/g, '');
            return !isNaN(cleanValue) && cleanValue !== '';
        }  
        
        function showNumberError(message) {

            // Displays error message and adds red border to input field
            // Makes validation feedback visible to user with styling changes

            const errorElement = document.getElementById('numberInputError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                // Add red border to input
                const input = errorElement.parentElement.querySelector('input');
                if (input) {
                    input.style.borderColor = '#e74c3c';
                }
            }
        }      

        function clearNumberError() {

            // Hides error message and resets input field border to normal
            // Called when user starts typing to clear previous error state

            const errorElement = document.getElementById('numberInputError');
            if (errorElement) {
                errorElement.style.display = 'none';
                
                // Reset border color
                const input = errorElement.parentElement.querySelector('input');
                if (input) {
                    input.style.borderColor = '#2196f3';
                }
            }
        }

        function handleNumberKeypress(event, inputElement, validation) {

            // Prevents non-numeric characters from being typed in real-time
            // Allows Enter to submit, digits/commas/spaces, but blocks letters instantly

            // Allow Enter key to submit
            if (event.key === 'Enter') {
                event.preventDefault();
                handleNumberSubmit(inputElement, validation);
                return;
            }
            
            // Allow backspace, delete, tab, escape, and arrow keys
            if ([8, 9, 27, 37, 38, 39, 40, 46].includes(event.keyCode)) {
                return;
            }
            
            // Allow commas and spaces for formatting
            if (event.key === ',' || event.key === ' ') {
                return;
            }
            
            // Only allow digits
            if (!/[0-9]/.test(event.key)) {
                event.preventDefault();
            }
        }

        // Update input options
        function updateInputOptions(options) {
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option.text;
                button.onclick = () => selectOption(option.value);
                inputOptions.appendChild(button);
            });

            // Flash to indicate new options are available
            setTimeout(() => flashInputOptions(), 50);
        }




        /*--------  EmailJS  --------*/


        async function sendEstimateEmails(customerEmail) {

            try {
                console.log('Preparing to send emails to', customerEmail);

                // Gather the estimate data
                const estimateData = generateEstimateData(customerEmail);

                console.log('üìã Full estimate data being sent:');
                console.log(JSON.stringify(estimateData, null, 2));  // ‚Üê Add this debug

                console.log('Estimate data prepared', estimateData);

                // Send email to customer
                console.log('Sending email to customer');
                await emailjs.send(
                    'service_ienqmwk', // EmailJS service ID
                    'template_0mza96t', // replace with your customer template ID
                    estimateData
                );
                console.log('Customer email sent successfully');

                // Send email to designer
                console.log('SEnding email to designer');
                await emailjs.send(
                    'service_ienqmwk',
                    'template_t3gpybn',
                    estimateData
                );

                console.log('üìß Service ID:', 'YOUR_SERVICE_ID');
                console.log('üìß Template IDs:', 'template_customer', 'template_designer');
                console.log('Email sent successfully');

                return { success: true };

            } catch (error) {
                console.error('Email sending failed', error);
                console.log('üìã Data that failed:', estimateData);  // ‚Üê Add this too
                throw new Error('Failed to send estimate emails');
            }

            // Collect all the user's choices
           /* const estimateData = {
                customer_email: customerEmail,
                room: conversationState.sessionData.initial,
                square_footage: conversationState.sessionData.square_footage,
                project_type: conversationState.sessionData.project_type,
                flooring: conversationState.sessionData.kitchen_flooring,
                // ... etc.
            };*/
        }

        function generateEstimateData(customerEmail) {
            // Calculate current total estimate
            const { minTotal, maxTotal } = calculateCurrentEstimate();

            // Gather all user selections
            const selections = [];
            Object.keys(conversationState.sessionData).forEach(step => {
                const value = conversationState.sessionData[step];
                if (value && step !== 'initial') {
                    // Format step names nicely
                    const stepName = step
                        .replace(/_/g, ' ')                         // Underscores -> spaces
                        .replace(/\b\w/g, l => l.toUpperCase());    // capitalize each word

                    selections.push(`${stepName}: ${value}`);
                }
            });

            // Current line items summary
            const lineItemsSummary = conversationState.costItems.map(item => {
                const price = calculateLineItemPrice(item);
                const priceStr = typeof price === 'number' ? `$${price.toLocaleString()}` : price;
                return `${item.name} - ${priceStr}`;
            }).join('\n');

            return {
                customer_email: customerEmail,
                customer_name: customerEmail.split('@')[0],
                room_type: conversationState.sessionData.initial,
                square_footage: conversationState.sessionData.square_footage,
                project_type: conversationState.sessionData.project_type,
                flooring: conversationState.sessionData.kitchen_flooring,

                selections_list: selections.join('\n'),  // ‚Üê Add this
                line_items: lineItemsSummary,            // ‚Üê Add this

                // Pricing
                estimate_min: `$${minTotal.toLocaleString()}`,
                estimate_max: `$${maxTotal.toLocaleString()}`,
                estimate_range: `$${minTotal.toLocaleString()} - $${maxTotal.toLocaleString()}`,
                
                // Timestamp
                date_submitted: new Date().toLocaleDateString(),
                time_submitted: new Date().toLocaleTimeString(),
                
                // For designer email
                lead_source: 'Kitchen Estimator Tool',
                follow_up_priority: maxTotal > 50000 ? 'High' : 'Medium'
            };
        }

        function calculateCurrentEstimate() {
            let runningTotal = 0;

            // Add always included items
            if (window.ALWAYS_INCLUDED) {
                window.ALWAYS_INCLUDED.forEach(item => {
                    runningTotal += item.price || 0;
                });
            }

            // Add current line items
            conversationState.costItems.forEach(item => {
                const calculatedPrice = calculateLineItemPrice(item);
                if (typeof calculatedPrice === 'number') {
                    runningTotal += calculatedPrice;
                }
            });

            // Calculate range
            const minTotal = Math.round(runningTotal * 0.9);
            const maxTotal = Math.round(runningTotal * 1.2);

            return { minTotal, maxTotal };
        }

        /*----------  BYPASS FUNCTION  ------------*/

        document.addEventListener('keydown', function(e) {
            // Ctrl + Shift + B = Bypass
            if (e.ctrlKey && e.shiftKey && e.key === 'B') {
                console.log('üß™ Keyboard bypass activated');
                if (conversationState.currentStep === 'email_capture') {
                    selectOption('test@example.com');
                }
            }
        });



        function updateEmailInput () {
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';

            const inputContainer = document.createElement('div');
            inputContainer.className = 'email-input-container';

            const emailInput = document.createElement('input');
            emailInput.type = 'email';
            emailInput.className = 'email-input';
            emailInput.placeholder = 'youremail@example.com';
            emailInput.required = true;

            const submitButton = document.createElement('button');
            submitButton.className = 'option-button email-submit-button';
            submitButton.textContent = 'Unlock premium features';

            submitButton.onclick = () => handleEmailSubmit(emailInput);

            const errorMessage = document.createElement('div');
            errorMessage.id = 'emailInputError';
            errorMessage.className = 'email-error-message';

            // Event listeners
            emailInput.addEventListener('input', () => clearEmailError());
            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleEmailSubmit(emailInput);
                }
            });

            inputContainer.appendChild(emailInput);
            inputContainer.appendChild(submitButton);
            inputContainer.appendChild(errorMessage);
            inputOptions.appendChild(inputContainer);

            setTimeout(() => flashInputOptions(), 50);
            setTimeout(() => emailInput.focus(), 100);
        }

        function showEmailError(message) {
            const errorElement = document.getElementById('emailInputError');
            const inputElement = document.querySelector('.email-input');

            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }

            if (inputElement) {
                inputElement.classList.add('error');
            }
        }

        function clearEmailError() {
            const errorElement = document.getElementById('emailInputError');
            const inputElement = document.querySelector('.email-input');

            if (errorElement) {
                errorElement.classList.remove('show');
            }

            if (inputElement) {
                inputElement.classList.remove('error');
            }
        }

        function handleEmailSubmit(inputElement) {

            // Check for URL bypass parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('bypass') === 'testing123') {
                console.log('üß™ Email bypass activated - skipping email send');
                
                // Skip straight to conversation progression
                addMessage('test@example.com', 'user');
                conversationState.sessionData[conversationState.currentStep] = 'test@example.com';
                setTimeout(() => {
                    progressConversation('test@example.com');
                }, 500);
                return; // Exit early, no email sending
            }

            const submitButton = inputElement.parentElement.querySelector('.option-button');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.style.opacity = '0.6';submitButton.textContent = 'Thinking...';
            }

            const email = inputElement.value.trim();

            //validate email
            if (!email) {
                showEmailError('Please enter your email address');
                resetEmailButton(submitButton);
                return;
            }

            if (!isValidEmail(email)) {
                showEmailError('Please enter a valid email address');
                resetEmailButton(submitButton);
            }

            // Send emails via EmailJS
            sendEstimateEmails(email)
                .then(() => {
                    // success proceed with conversation
                    // selectOption(email);  // Changed

                    // Skip selectOption entirely and call progressConversation directly
                    addMessage(email, 'user');
                    conversationState.sessionData[conversationState.currentStep] = email;
                    setTimeout(() => {
                        progressConversation(email);
                    }, 500);
                })
                .catch((error) => {
                    console.error('Email send failed', error);
                    showEmailError('Failed to send email. Please try again.');
                    resetEmailButton(submitButton);
                })
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showEmailError(message) {
            const errorElement = document.getElementById('emailInputError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';

                const input = errorElement.parentElement.querySelector('input');
                if (input) {
                    input.style.borderColor = '#e74c4c';
                }
            }
        }

        function clearEmailError() {
            const errorElement = document.getElementById('emailInputError');
            if (errorElement) {
                errorElement.style.display = 'none';

                const input = errorElement.parentElement.querySelector('input');
                if (input) {
                    input.style.borderColor = '#2196f3';
                }
            }
        }

        function resetEmailButton(button) {
            if (button) {
                button.disabled = false;
                button.style.opactiy = '1';
                button.textContent = 'Unlock premium features';
            }
        }

        /* ------- LINE ITEM PRICING CALCs ------------*/

        function calculateLineItemPrice(lineItem) {
            // Calculates actual price for a line item based on user selection and square footage
            // Returns formatted price string or range

            // Enhanced debugging for flooring pricing issues
            console.log('=== calculateLineItemPrice DEBUG ===');
            console.log('Full lineItem:', lineItem);
            
            //if (!window.PRICING || !lineItem) return 'TBD';

            if (!window.PRICING || !lineItem) {
                console.log('Missing PRICING or lineItem');
                return 'TBD';
            }

            // Get the base item name (before the colon)
            const baseName = lineItem.name.split(':')[0].trim();
            console.log('baseName extracted:', baseName);
            console.log('Available PRICING keys:', Object.keys(window.PRICING));

            // Special case for cabinet organizers
            if (lineItem.stepName === 'kitchen_cabinet_organizers') {
                console.log('üîß Cabinet organizer detected, using special pricing lookup');
                const organizerPricing = window.PRICING["Cabinet Organizers"];
                if (organizerPricing && organizerPricing[lineItem.userChoice]) {
                    console.log('üîß Found organizer pricing:', organizerPricing[lineItem.userChoice]);
                    return organizerPricing[lineItem.userChoice].flat;
                }
                console.log('üîß No organizer pricing found for:', lineItem.userChoice);
                return 'TBD';
            }

            const pricing = window.PRICING[baseName];
            //if (!pricing) return 'TBD';

            if (!pricing) {
                console.log('No pricing found for baseName:', baseName);
                return 'TBD';
            }
            
            /*const pricing = window.PRICING[lineItem.name.split(':')[0]]; // Get base name without selection
            if (!pricing) return 'TBD';*/

            // ENHANCED DEBUG - Let's see what's actually in the pricing object
            console.log('Type of pricing object:', typeof pricing);
            console.log('Pricing object contents:', pricing);
            console.log('Keys in pricing object:', Object.keys(pricing));

            const userChoice = lineItem.userChoice;
            console.log('User choice:', userChoice);
            console.log('Looking for key:', userChoice);
            console.log('Direct lookup result:', pricing[userChoice]);
            
            // Test if the key exists with different methods
            console.log('hasOwnProperty test:', pricing.hasOwnProperty(userChoice));
            console.log('in operator test:', userChoice in pricing);


            
            // const userChoice = lineItem.userChoice;
            //const projectType = conversationState.sessionData.project_type;

            //const itemPricing = pricing[projectType] || pricing['default'];
            const itemPricing = pricing[userChoice] || pricing['default'];

            console.log('Item pricing found:', itemPricing);
            

            // if (!itemPricing) return 'TBD';

                if (!itemPricing) {
                console.log('No item pricing found for choice:', userChoice);
                return 'TBD';
            }
            
            const sqft = parseInt(conversationState.sessionData.square_footage || 0);
            console.log('Square footage:', sqft);
            console.log('Calculation type:', lineItem.calculation);
            
            if (lineItem.calculation === 'perSqFt' && sqft > 0) {
                //const price = itemPricing.perSqFt * sqft;
                return itemPricing.perSqFt * sqft;
                //console.log('Calculated perSqFt price:', price);
                // return price;
            } else if (lineItem.calculation === 'flat') {
                //console.log('Returning flat price:', itemPricing.flat);
                return itemPricing.flat;
            }
            
            return 'TBD';
        }


        // Update cost estimate
        function updateCostEstimate() {
            const costItems = document.getElementById('costItems');
            const totalRange = document.getElementById('totalRange');
            
            // Clear existing items (except always included)
            costItems.innerHTML = '';

            let runningTotal = 0;
            
            // Add always included items
            if (window.ALWAYS_INCLUDED) {
                window.ALWAYS_INCLUDED.forEach(item => {
                    addCostItem(item.name, item.price);
                    runningTotal += item.price || 0;
                });
            }
            
            // Add dynamic cost items (placeholder pricing for now)
            conversationState.costItems.forEach(item => {
                const calculatedPrice = calculateLineItemPrice(item);
                addCostItem(item.name, calculatedPrice);

                // Add to running total if it's a number
                if (typeof calculatedPrice === 'number') {
                    runningTotal += calculatedPrice;
                }

            });

            // Calculate range (10% below and 20% above for est. range)
            const minTotal = Math.round(runningTotal * 0.9);
            const maxTotal = Math.round(runningTotal * 1.2);
            
            // Calculate totals (placeholder)
            /*let baseTotal = window.ALWAYS_INCLUDED ? 
                window.ALWAYS_INCLUDED.reduce((sum, item) => sum + item.price, 0) : 0;
            let rangeMultiplier = conversationState.costItems.length * 500; // Placeholder
            */

            //totalRange.textContent = `${baseTotal.toLocaleString()} - ${(baseTotal + rangeMultiplier).toLocaleString()}`;

            totalRange.textContent = `$${minTotal.toLocaleString()} - $${maxTotal.toLocaleString()}`;
        }

        // Add cost item to display
        function addCostItem(name, price) {
            const costItems = document.getElementById('costItems');
            const costItemDiv = document.createElement('div');
            costItemDiv.className = 'cost-item';


            let displayPrice;
            if (typeof price === 'number') {
                displayPrice = '$' + price.toLocaleString();
            } else {
                displayPrice = price;
            }

            
            costItemDiv.innerHTML = `
                <span class="cost-item-name">${name}</span>
                <span class="cost-item-price">${typeof price === 'number' ? '$' + price : price}</span>
            `;
            
            costItems.appendChild(costItemDiv);
        }

        // Initialize conversation
        function initializeConversation() {

            console.log('initializeConversation called!', new Date().getTime());

            // Don't show anything until convresation flow is loaded

            if (!window.CONVERSATION_FLOW || !window.CONVERSATION_FLOW.initial) {

                // Config not loaded yet, try again in a Moment
                setTimeout(initializeConversation, 100);
                return;
            }

                const initialStep = window.CONVERSATION_FLOW.initial;
                
                // Clear default message and show initial question
                document.getElementById('conversationFlow').innerHTML = '';
                document.getElementById('inputOptions').innerHTML = '';

                // Use the same statement logic as progressConversation
                if (initialStep.statementTiming === 'before') {
                    // Statement first, then question
                    displayStatement(initialStep.statement, () => {
                        if (initialStep.question) {
                            addMessage(initialStep.question);
                        }
                        setTimeout(() => showInputs(initialStep), window.CONVERSATION_TIMING.statementDelay);
                    });
                } else {
                    // Default behavior (just question)
                    if (initialStep.question) {
                        addMessage(initialStep.question);
                    }
                    setTimeout(() => showInputs(initialStep), 100);
                }


                /*
                addMessage(initialStep.question);
                
                // Set up initial options
                updateInputOptions(initialStep.options.map(option => ({
                    text: option,
                    value: option
                })));
            }*/
            
            // Initialize cost display
            updateCostEstimate();
            setTimeout(updateProgress, 200); // Calls after initialization
        }

        // Initialize when page loads and conversation flow is available
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for conversation-flow.js to load
            setTimeout(initializeConversation, 100);
        });
    </script>
</body>
</html>