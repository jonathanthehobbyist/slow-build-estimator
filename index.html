<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interior Design Estimator</title>
    <script src="conversation-flow.js"></script>
    <script src="pricing-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS (you'll get this from EmailJS dashboard)
        emailjs.init('WDXkQzVjEd5RcRLZ0'); // Replace with your actual public key
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700&family=IBM+Plex+Sans:ital,wght@0,400;0,500;0,600;0,700&&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
        /* Font Families */
        --font-serif: 'IBM Plex Mono', 'Times New Roman', serif;
        --font-sans: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

        /* Accents */
         --accent-rusty: #D25D39;
         --accent-rusty-hover: #BD4F2D;

        /* Font Sizes */
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;

        /* Font Weights */
        --font-normal: 400;
        --font-medium: 500;
        --font-semibold: 600;
        --font-bold: 700;

        /* Line Heights */
        --leading-tight: 1.25;
        --leading-normal: 1.5;
        --leading-relaxed: 1.6;
        --leading-loose: 1.75;

        /* Primary Colors */
        --primary-50: #eff6ff;
        --primary-100: #dbeafe;
        --primary-500: #3b82f6;
        --primary-600: #2563eb;
        --primary-700: #1d4ed8;

        /* Neutral Colors (Claude-inspired) */
        --neutral-50: #faf9f9;
        --neutral-100: #f1efef;
        --neutral-200: #e6e4e2;
        --neutral-300: #d2cfcc;
        --neutral-400: #a09c98;
        --neutral-500: #5a5652;
        --neutral-600: #6b6b6b;
        --neutral-700: #3d3936;
        --neutral-800: #2d2d2d;
        --neutral-900: #1a1816;

        /* Semantic Colors */
        --success-50: #f0fdf4;
        --success-500: #22c55e;
        --success-600: #16a34a;

        --warning-50: #fffbeb;
        --warning-500: #f59e0b;
        --warning-600: #d97706;

        --error-50: #fef2f2;
        --error-500: #ef4444;
        --error-600: #dc2626;

        /* Application-Specific Colors */
        --background: var(--neutral-50);
        --white: #ffffff;
        --surface: var(--neutral-100);
        --surface-hover: var(--neutral-200);

        /* Text Colors */
        --text-primary: var(--neutral-800);
        --text-secondary: var(--neutral-600);
        --text-tertiary: var(--neutral-500);
        --text-inverse: #ffffff;

        /* Border Colors */
        --border-light: var(--neutral-200);
        --border-medium: var(--neutral-300);
        --border-strong: var(--neutral-400);

        /* Message Bubble Colors */
        --message-system-bg: var(--neutral-100);
        --message-system-text: var(--text-primary);
        --message-system-border: var(--border-light);

        --message-user-bg: var(--neutral-100);
        --message-user-text: var(--text-inverse);

        /* Button Colors */
        --button-primary-bg: var(--primary-600);
        --button-primary-hover: var(--primary-700);
        --button-primary-text: var(--text-inverse);

        --button-secondary-bg: var(--surface);
        --button-secondary-hover: var(--surface-hover);
        --button-secondary-text: var(--text-primary);
        --button-secondary-border: var(--neutral-500);

        /* Progress Bar Colors */
        --progress-bg: var(--neutral-200);
        --progress-fill: linear-gradient(90deg, var(--success-500) 0%, var(--success-600) 100%);

        /* Cost Panel Colors */
        --cost-total-bg: var(--white);
        --cost-item-border: var(--border-light);

        /* Gallery Colors */
        --gallery-card-bg: var(--surface);
        --gallery-card-border: var(--border-light);
        --gallery-card-hover-border: var(--accent-rusty-hover);
        --gallery-card-selected-bg: var(--primary-50);
        --gallery-card-selected-border: var(--accent-rusty-hover);

        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

        /* Spacing System */
        --space-xs: 0.25rem;
        --space-sm: 0.5rem;
        --space-half-sm: .75rem;
        --space-md: 1rem;
        --space-lg: 1.5rem;
        --space-xl: 2rem;
        --space-2xl: 3rem;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 18px;
        --radius-full: 50%;

        /* Sometimes there's a box over a box and the border needs to be... */
        --radius-sm-selected: 6px;
        --radius-md-selected: 10px;
        }


        body {
            font-family: var(--font-sans);
            background-color: var(--background);
            color: var(--text-primary);
            line-height: var(--leading-relaxed);
            font-size: var(--text-base);
            font-weight: var(--font-normal);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Mobile-first layout */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
        }

        /* Conversation Panel */
        .conversation-panel {
            background: var(--surface);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            min-height: 400px;
            max-height: 85vh;
        }

        .conversation-header {
            padding-left: var(--space-xl);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--neutral-300);
        }

        .conversation-header,
        .cost-header {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
            color: var(--text-primary);
            padding: var(--space-lg);
            /* border-bottom: 1px solid var(--border-light); */
        }



        .conversation-flow {
            flex: 1;
            padding: var(--space-md) var(--space-xl) var(--space-md) var(--space-xl);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            /* Add these for better scrolling */
            min-height: 0; /* Important for flex children */
            scroll-behavior: smooth;
            max-height: calc(85vh - 140px);
        }

        /* Gallery mode - full height when input options are hidden */
        .conversation-flow.gallery-mode {
            max-height: none; /* calc(85vh - 60px); Only account for header */
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .message.system {
            align-items: flex-start;
        }

        .message.user {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.system .message-bubble {
            background: transparent; /* No background for system messages */
            color: var(--message-system-text);
            border: none;

            /* Serif for system responses - more conversational */
            font-family: var(--font-serif);
            font-size: var(--text-base);
            line-height: var(--leading-relaxed);
            font-weight: var(--font-normal);

            /* Full width with padding */
            width: 100%;
            max-width: none;
            padding: var(--space-md) 0;
            border-radius: 0;
        }

        .message.user .message-bubble {
            background: var(--neutral-200);
            color: var(--text-primary);
            border: none;

            /* Sans-serif for user responses - more direct */
            font-family: var(--font-sans);
            font-size: var(--text-lg);
            line-height: var(--leading-normal);
            font-weight: var(--font-);

            /* Full width with subtle background */
            width: 100%;
            max-width: none;
            padding: var(--space-sm) var(--space-md) var(--space-half-sm) var(--space-md);
            border-radius: var(--radius-md);
            margin-top: var(--space-sm);            

        }

        .message-user .message-image {
            margin-right: auto;
        }

        .message-system .message-image {
            margin-right: auto;
        }

        .user-image {
            max-width: 150px;
            max-height: 100px;
        }

                /* User Image Card Styles */
        .user-image-card {
            width: 100%;
            max-width: none;
            background: var(--white);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: var(--space-sm);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column; /* ‚Üê Force vertical on mobile */
        }

        .user-image-card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .user-image-card-content {
            padding: var(--space-md);
            background: var(--white);
        }

        .user-image-card-title {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-base);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            line-height: var(--leading-tight);
        }

        .user-image-card-description {
            font-family: var(--font-sans);
            font-weight: var(--font-normal);
            font-size: var(--text-sm);
            color: var(--text-secondary);
            line-height: var(--leading-normal);
        }

        .message-image {
            max-width: 120px;
            max-height: 80px;
            border-radius: 6px;
            margin: 0.5rem 0;
            object-fit: cover;
            border: 1px solid #ddd;
            display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Email input container */
        .email-input-container {
            display: flex;
            gap: 0.25rem;
            width: 100%;
        }

        
        .email-input-container input { flex: 2; }
        .email-input-container button { flex: 1; } 

        /* ============ INPUT FIELDS ==============  */

        /* Email input field */

        .email-input {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            font-weight: var(--font-normal);
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--primary-500);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .email-input:focus {
            outline: none;
            border-color: var(--accent-rusty);
            box-shadow: 0 0 0 3px rgba(var(--accent-rusty), 0.1);
        }

        .email-input.error {
            border-color: #e74c3c;
        }

        /* Email error message */
        .email-error-message,
        .number-input-error {
            font-family: var(--font-sans);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--error-500);
            margin-top: var(--space-xs);
        }

        .email-input::placeholder {
            color: var(--text-tertiary);
            font-style: italic;
        }

        input.number-input {
            background: var(--user-message-bg); /* Same as user message #F1EFEF */
            border: 1px solid var(--neutral-200);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-family: var(--font-sans);
            font-size: var(--text-sm);
            color: var(--text-primary);
            width: 200px; /* Constrained width like in image */
        }

        input.number-input:focus {
            border: 1px solid var(--neutral-800)!important;
            outline-color: var(--accent-rusty);
        }

        input.number-input::placeholder {
            color: var(--text-secondary);
        }




        /* ============ BUTTONS ==============  */

        /* Base button styles - shared by all buttons */
        .btn {
            font-family: var(--font-sans);
            font-weight: 600;
            font-size: var(--text-base);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            border: none;
        }

        /* PRIMARY BUTTONS - Rust colored for main actions */
        .btn-primary {
            background-color: var(--accent-rusty);
            color: white;
            border: none;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-rusty-hover);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* SECONDARY BUTTONS - White with border for options/selections */
        .btn-secondary {
            background: var(--white);
            border: 1px solid var(--neutral-500);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--neutral-50);
            border-color: var(--neutral-600);
        }

        .btn-secondary:disabled {
            background-color: #f5f5f5;
            color: #999;
            border-color: #ddd;
            cursor: not-allowed;
        }

        .btn-secondary.selected {
            background: var(--user-message-bg);
            border-color: var(--accent-rusty);
        }

        /* SPECIFIC BUTTON CLASSES - For backwards compatibility */

        #galleryConfirmButton {
            /* Container for Gallery */

            margin-top: var(--space-lg);
            text-align: left;
            padding: var(--space-lg);
            background-color: var(--white);
            border-radius: var(--radius-lg);
            border-color: var(--neutral-100);
        }

        /* Using the rust accent color, stand-alone buttons */
        .option-button.continue-button,
        .option-button.primary,
        .option-button.email-submit-button.primary {
            font-family: var(--font-sans);
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            border: none;
            background-color: var(--accent-rusty);
            color: var(--text-inverse);
        }

        .continue-button:hover:not(:disabled),
        .option-button.continue-button:hover:not(:disabled),
        .option-button.primary:hover:not(:disabled),
        .option-button.email-submit-button.primary:hover:not(:disabled),
        .email-submit-button:hover:not(:disabled) {
            background-color: var(--accent-rusty-hover);
            transform: translateY(-1px);
        }

        .continue-button:disabled,
        .email-submit-button:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* White bg, grey border, usually buttons in groups */
        .option-button,
        .option-button .skip,
        .multi-select-button {
            font-family: var(--font-sans);
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            background: var(--white);
            border: 1px solid var(--neutral-400);
            color: var(--text-primary);
        }

        .option-button:hover:not(:disabled),
        .multi-select-button:hover:not(:disabled) {
            background: var(--neutral-50);
            border-color: var(--neutral-600);
        }

        .option-button:disabled,
        .multi-select-button:disabled {
            background-color: #f5f5f5;
            color: #999;
            border-color: #ddd;
            cursor: not-allowed;
        }

        .option-button.selected,
        .multi-select-button.selected {
            background: var(--user-message-bg);
            border-color: var(--accent-rusty);
        }

        .option-button.text-link {
            color: var(--accent-rusty)!important;
            border: none!important;
            background: transparent;
            font-weight: var(--text-base);
        }

        /* ============== GALLERY CARDS ETC ============== */

        /* Multi-select gallery card base styles */
        /*.gallery-card,
        .multi-select-gallery-card {
            display: flex;
            align-items: center;
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--neutral-200);
            border-radius: var(--space-sm);
            overflow: hidden;
            transition: all 0.2s ease;
        } */

        /* Sticky question area */
        .current-question {
            position: sticky;
            top: 0;
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 2rem;
            z-index: 20;
            font-family: var(--font-serif);
            font-size: var(--text-base);
            line-height: var(--leading-relaxed);
            color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Hide when no current question */
        .current-question.hidden {
            display: none;
        }

        /* Adjust conversation flow to account for sticky header */
        .conversation-flow {
            /* Keep existing styles */
        }

        .gallery-card,
        .multi-select-gallery-card {
            border-radius: var(--space-sm);
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            overflow: hidden;
            background-color: var(--gallery-card-bg);
            transition: all 0.3s ease;
            position: relative;
        }

        /* Image styling for full width cards */
        .gallery-card .card-image,
        .multi-select-gallery-card .card-image {
            width: 100%; /* Fixed width for image */
            height: 180px;
            object-fit: cover;
            flex-shrink: 0;
            display: block;
        }

        /* Content area takes remaining space */
        .gallery-card .card-content,
        .multi-select-gallery-card .card-content {
            flex: 1;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--white);
        }

        .gallery-card:hover,
        .multi-select-gallery-card:hover {
            border-color: var(--gallery-card-hover-border);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Multi-select gallery card selected state */
        .gallery-card.selected,
        .multi-select-gallery-card.selected {
            border-color: var(--gallery-card-selected-border);
            background-color: var(--gallery-card-selected-bg);
            transform: translateY(-2px)!important;
            box-shadow: 0 4px 12px rgba(var(--neutral-500), 0.2)!important;
            border-radius: var(--radius-md-selected);
        }

        /* Multi-select gallery card image */
        .gallery-card .card-image,
        .multi-select-gallery-card .card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
            border-radius: var(--space-sm) var(--space-sm) 0 0;
        }

        /* Multi-select gallery card content */
        .gallery-card .card-content,
        .multi-select-gallery-card .card-content {
            padding: 0.75rem;
            border-radius: 0 0 var(--space-sm) var(--space-sm);
        }

        .gallery-card .card-title,
        .multi-select-gallery-card .card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .gallery-card .card-description,
        .multi-select-gallery-card .card-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        /* Selection checkmark for multi-select */
        /*.multi-select-gallery-card .selection-checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
        }*/

        /* Multi-select gallery container */
        .gallery-container,
        .multi-select-gallery-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Single column, full width */
            gap: 1rem;
            width: 100%;
            margin: 0 0 var(--space-lg) 0; /* Remove margins */
            padding: 0; /* Remove padding */
        }

        /* Multi-select gallery overlay */

        .gallery-overlay,
        .multi-select-gallery-overlay {
            width: 100%;
            padding-top: 2rem; /* Only top/bottom padding */
            padding-bottom: 1rem;
            padding-left: 0rem;
            padding-right: 0rem;
            background: transparent;
            margin: 0;
            border-radius: var(--radius-md);
            margin-top: 1rem;
        }

        .gallery-overlay,
        .multi-select-gallery-overlay {
            opacity: 0;
            transform: translateY(20px);
            animation: slideInGallery 0.6s ease-out forwards;
        }

        @keyframes slideInGallery {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .multi-select-gallery-instructions {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-base);
            color: var(--text-primary);
            margin-bottom: var(--space-lg);
        }



        /* Single-column gallery container */
        .gallery-container-single {
            display: grid !important;
            grid-template-columns: 1fr !important;  /* Force single column */
            gap: 1rem !important;
            width: 100% !important;
            /* max-width: 500px !important; */ /* Limit width for better appearance */
            margin: 0 auto !important;    /* Center the column */
        }

        /* Make cards full width and taller in single-column */
        .gallery-container-single .gallery-card {
            width: 100% !important;
            max-width: none !important;
            min-height: 300px !important;  /* ‚Üê Make cards taller */
        }

        /* Much larger images for single-column */
        .gallery-container-single .gallery-card img {
            height: 240px !important;  /* ‚Üê Increased from 200px */
            width: 100% !important;
        }

        /* More spacious content padding */
        .gallery-container-single .gallery-card .card-content {
            padding: 1.5rem !important;  /* ‚Üê More padding */
            flex: 1;  /* ‚Üê Take up remaining space */
        }

        /* Larger text for single-column cards */
        .gallery-container-single .gallery-card .card-title {
            font-family: var(--font-sans);
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            line-height: var(--leading-tight);
        }

        .gallery-container-single .gallery-card .card-description {
            font-family: var(--font-sans);
            font-weight: var(--font-normal);
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            line-height: var(--leading-normal);
        }

        /* Gallery card selection state */
        .gallery-card {
            transition: all 0.3s ease;
            position: relative;

            background: var(--gallery-card-bg);
            border: 2px solid var(--gallery-card-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        .gallery-card:hover {
            border-color: var(--gallery-card-hover-border);
            box-shadow: var(--shadow-md);
        }

        .gallery-card.selected {
            background: var(--gallery-card-selected-bg);
            border-color: var(--gallery-card-selected-border);
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2) !important;
        }



        /* Selection checkmark */
        .selection-checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--accent-rusty);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .multi-select-image-card {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: center;
        }

        /* 4-column image grid for multi-select responses */
        .multi-select-image-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
            max-width: 400px; /* Constrain total width */
        }

        .grid-image-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 0 0 auto; /* Don't grow or shrink, size to content  */
            max-width: 200px;
        }

        .grid-image {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: var(--space-sm);
            border: 1px solid var(--neutral-200);
        }

        .grid-image-label {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-top: 0.25rem;
            line-height: 1.2;
        }

        /* Responsive - 2 columns on mobile */
        @media (max-width: 768px) {
            .multi-select-image-grid {
                grid-template-columns: repeat(2, 1fr);
                max-width: 200px;
            }
        }

        .input-options {
            position: static;
            padding: 1.5rem 1rem;
            border: none;
            background: var(--white);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Add shadow like in image */
            border-radius: 8px;
            margin: 1rem 2rem; /* Space from edges */
            display: flex;
            flex-direction: row; /* Side by side */
            flex-wrap: wrap;
            gap: 0.25rem;
            max-height: none;
            min-height: 84px;
            overflow: visible;
        }



        /* Cost Panel */
        .cost-panel {
            background: var(--white);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-lg);
            border-left: 1px solid var(--neutral-300);
            display: flex;
            flex-direction: column;
            min-height: 300px;
            max-height: 85vh;
        }

        /*.cost-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e5e5;
            font-weight: 600;
            color: #2c3e50;
        }*/

        /* Line item flash animation */
        @keyframes lineItemFlash {
            0% {
                background-color: var(--accent-rusty);
                transform: translateX(-10px);
                opacity: 0;
            }
            50% {
                background-color: var(--accent-rusty);
                opacity: 1;
            }
            100% {
                background-color: transparent;
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cost-items {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        .cost-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: var(--space-xs) 0;
            border-bottom: 1px solid var(--cost-item-border);
            transition: all 0.3s ease;
        }

        .cost-item.new-item {
            animation: lineItemFlash 0.8s ease-out;
        }

        .cost-item:last-child {
            border-bottom: none;
        }

        .cost-item-name {
            font-family: var(--font-serif);
            font-weight: var(--font-normal);
            font-size: var(--text-sm);
            color: var(--text-primary);
            line-height: var(--leading-normal);
            flex: 1;
        }

        .cost-item-price {
            font-family: var(--font-serif);
            font-weight: var(--font-normal);
            font-size: var(--text-sm);
            color: var(--text-primary);
        }

        .total-section {
            padding: 1rem;
            background: var(--cost-total-bg);
            border-top: none;
            display: flex;
            justify-content: space-between;
        }

        .total-range {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-serif);
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
            color: var(--text-primary);
        }

        .range-display {
            display: flex;
            font-family: var(--font-serif);
            font-weight: var(--font-normal);
            font-size: var(--text-sm);
            color: var(--text-primary);
            text-align: right;
            /* padding: var(--space-md) var(--space-xl); */
            background: none;
            /* margin-top: var(--space-sm); */
        }

        /* Custom scrollbar styling */
        .conversation-flow::-webkit-scrollbar,
        .cost-items::-webkit-scrollbar,
        .input-options::-webkit-scrollbar {
            width: 6px;
        }

        .conversation-flow::-webkit-scrollbar-track,
        .cost-items::-webkit-scrollbar-track,
        .input-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .conversation-flow::-webkit-scrollbar-thumb,
        .cost-items::-webkit-scrollbar-thumb,
        .input-options::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .conversation-flow::-webkit-scrollbar-thumb:hover,
        .cost-items::-webkit-scrollbar-thumb:hover,
        .input-options::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }


        .progress-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            border: none;
            padding: 0;
            z-index: 10;
        }

        .progress-bar {
            height: 100%;
            background: transparent; /* Your rust color #DE7D60 */
            border-radius: 0;
            transition: width 0.6s ease-out;
            width: 100%;
        }

        .progress-fill {
          height: 100%;

          background-color: var(--accent-rusty); /*linear-gradient(90deg, #4CAF50 0%, #45a049 100%);*/
          border-radius: 4px;
          transition: width 0.3s ease-in-out;
          width: 0%;
        }

        .progress-text {
          font-family: var(--font-sans);
          font-weight: var(--font-medium);
          font-size: var(--text-sm);
          color: var(--text-secondary);
          text-align: right;
          padding-right: var(--space-md);
          padding-top: var(--space-md);
        }

        /* Animated progress fill */
        .progress-fill.animate {
          background: linear-gradient(90deg, #4CAF50 0%, #45a049 50%, #4CAF50 100%);
          background-size: 200% 100%;
          animation: progressShimmer 1.5s ease-out;
        }

        @keyframes progressShimmer {
          0% { background-position: -200% 0; }
          100% { background-position: 200% 0; }
        }
        /* Responsive adjustments */
        @media (max-height: 600px) {
            .conversation-panel,
            .cost-panel {
                max-height: 90vh;
            }
            
            .conversation-flow {
                max-height: calc(90vh - 140px);
            }
            
            .cost-items {
                max-height: calc(90vh - 200px);
            }
        }

        /* Desktop layout */
        @media (min-width: 768px) {

            .main-content {
                flex-direction: row; /* Keep side by side */
                min-height: 100vh;
                max-height: 100vh;
                overflow: hidden; /* Prevent double scrollbars */
                gap: 0;
                padding: 0;
            }

            .conversation-header {
                font-size: var(--text-sm);
                padding: var(--space-md) var(--space-xl) var(--space-sm) var(--space-xl);
            }


            .cost-header {
                font-size: var(--text-sm);
                padding: var(--space-md);
            }

            .message.system .message-bubble,
            .message.user .message-bubble {
                /* padding: var(--space-sm) 0; */
            }

            .range-display {
                font-size: var(--text-sm);
                text-align: right;
                /* padding: var(--space-sm) var(--space-lg);*/
            }

            .conversation-panel {
                border-radius: 0;
                box-shadow: none;
                border-right: 1px solid var(--border-light);
                position: relative;
                display: flex;
                flex-direction: column;
                min-height: 0; /* Important for flex children */
                overflow: hidden;
            }

            .cost-panel {
                border-radius: 0;
                box-shadow: none;
                position: static;
            }

            .message-image {
                max-width: 300px;
            }
        }

        /* Large desktop */
        @media (min-width: 1024px) {
            .conversation-panel {
                flex: 3;
            }

            .cost-panel {
                flex: 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <!-- Conversation Panel -->
            <div class="conversation-panel">
                <div class="conversation-header">
                    Interior Design Consultation
                </div>

                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                  </div>
                  <div class="progress-text" id="progressText">Step 1 of 12</div>
                </div>

                <div class="current-question hidden" id="currentQuestion"></div>
                
                <div class="conversation-flow" id="conversationFlow">
                    <!-- Messages will be dynamically added here -->
                </div>

                <div class="input-options" id="inputOptions">
                 <!-- Options loaded dynamically -->
                </div>
            </div>

            <!-- Cost Panel -->
            <div class="cost-panel">
                <div class="cost-header">
                    Project Estimate
                </div>
                
                <div class="cost-items" id="costItems">
 
                    <!-- Cost items will be dynamically added here -->
                </div>

                <div class="total-section">
                    <div class="total-range">
                        <span>Estimated Total:</span>
                    </div>
                    <div class="range-display" id="totalRange">
                        $150 - $300
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple state management
        let conversationState = {
            currentStep: 'initial',
            sessionData: {},
            costItems: [],
            displayedCostItems: []
        };

        function showLoadingState() {
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '<div style="text-align: center; color: #666;">Loading options...</div>';
        }

        // Might be extra, remove later

        /* document.addEventListener('DOMContentLoaded', function() {
            showLoadingState();
            setTimeout(initializeConversation, 100);
        }); */

        // Add message to conversation
        function addMessage(content, type = 'system', imageUrl = null) {

            console.log('addMessage called:', content, type);

            const conversationFlow = document.getElementById('conversationFlow');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let messageHTML = `<div class="message-bubble">${content}</div>`;
            
            if (imageUrl) {
                messageHTML += `<img src="${imageUrl}" alt="${content}" class="message-image ${type}-image">`;
            }
            
            messageDiv.innerHTML = messageHTML;
            conversationFlow.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => { 
                conversationFlow.scrollTop = conversationFlow.scrollHeight;
            }, 200);
        }

        function formatOptions(options) {
            // Handle different input types
            if (typeof options === 'string') {
                return options;
            }
            console.log('formatOptions - OPTIONS:', options);


            
            if (!Array.isArray(options)) {
                return String(options);
            }
            
            // Handle array formatting
            if (options.length === 0) {
                return '';
            } else if (options.length === 1) {
                return options[0];
            } else if (options.length === 2) {
                return `${options[0]} and ${options[1]}`;
            } else {
                // 3+ options: "item1, item2, and item3"
                const lastItem = options[options.length - 1];
                const firstItems = options.slice(0, -1);
                return `${firstItems.join(', ')}, and ${lastItem}`;
            }
        }

        // Handle option selection
        function selectOption(option) {

            console.log('selectOption called', option);

            //disable all buttons immediately
            disableAllButtons();

            // Add user message
            //addMessage(option, 'user');
            
            // Get the current step config
            const stepConfig = window.CONVERSATION_FLOW[conversationState.currentStep];

            // Only show user message if user response template exists
            if(stepConfig && stepConfig.userResponseTemplate) {

                const formattedOptions = formatOptions(option);
                const displayMessage = stepConfig.userResponseTemplate.replace('{selection}', formattedOptions);

                // Added
                addMessage(displayMessage, 'user');
            }

            /*let displayMessage = option;
            if (stepConfig && stepConfig.userResponseTemplate) {
                displayMessage = stepConfig.userResponseTemplate.replace('{selection}', option);
            }*/


            

            // Store selection in sessionData
            conversationState.sessionData[conversationState.currentStep] = option;
            
            // Update buttons
            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Debug logging
            console.log('Selected:', option);
            console.log('Current step:', conversationState.currentStep);
            console.log('Session data:', conversationState.sessionData);

            setTimeout(updateProgress, 100); // Call for immediate feedback
            
            // Progress conversation
            setTimeout(() => {
                progressConversation(option);
            }, 500);
        }

        function disableAllButtons() {

            // Prevents unintentional double-clicks

            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            });
        }

        function updateSelectedButton(clickedButton) {
            // Highlights selected while keeping other disabled
            // Visual feedback
            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.classList.remove('selected'));

            if (clickedButton) {
                clickedButton.classList.add('selected');
                clickedButton.style.opacity = '1'; // make selected button fully visible
            }
        }

        // Conversation, question & statement handlers

        function displayStatement(statementText, callback) {
          if (statementText) {
            addMessage(statementText, 'system');
            setTimeout(callback, window.CONVERSATION_TIMING.statementDelay);
          } else {
            callback(); // No statement, proceed immediately
          }
        }

        function updateContinueInput() {
          const inputOptions = document.getElementById('inputOptions');
          inputOptions.innerHTML = '';
          
          const continueButton = document.createElement('button');
          continueButton.className = 'option-button primary';
          continueButton.textContent = 'Continue';
          continueButton.onclick = () => selectOption('continue');
          
          inputOptions.appendChild(continueButton);

          // Flash to indicate continue button is available
          setTimeout(() => flashInputOptions(), 50);
        }

        function progressConversation(lastSelection) { 
            console.log('üöÄ progressConversation called with:', lastSelection);  // ‚Üê Add this
            console.log('üöÄ typeof lastSelection:', typeof lastSelection);  // ‚Üê Add this
            console.log('üöÄ Array.isArray(lastSelection):', Array.isArray(lastSelection));  // ‚Üê Add this
    

            // Get line items for the current step
            if (window.ConversationFlowHelper) {
                console.log('üöÄ ConversationFlowHelper exists, calling getLineItemsForStep');  // ‚Üê Add this
                const lineItems = window.ConversationFlowHelper.getLineItemsForStep(
                    conversationState.currentStep, 
                    lastSelection
                );

                // DEBUG: Check if line items are being generated
                console.log('Current step:', conversationState.currentStep);
                console.log('Last selection:', lastSelection);
                console.log('Generated line items:', lineItems);
                console.log('Line items length:', lineItems.length);
                
                // Add line items to cost estimate
                lineItems.forEach(item => {
                    console.log('Adding line item:', item);
                    conversationState.costItems.push(item);
                });
                console.log('Total cost items now:', conversationState.costItems);
            }

            const currentStepConfig = window.CONVERSATION_FLOW[conversationState.currentStep];
            if(currentStepConfig && currentStepConfig.responseLogic) {
                const responseMessage = currentStepConfig.responseLogic(lastSelection, conversationState.sessionData);
                if(responseMessage) {
                    setTimeout(() => {
                        addMessage(responseMessage, 'system');
                    }, 800) // delay to feel more natural

                }
            }
            
            // Get next step
            let nextStep;
            if (window.ConversationFlowHelper) {
                nextStep = window.ConversationFlowHelper.getNextStep(
                    conversationState.currentStep, 
                    lastSelection, 
                    conversationState.sessionData
                );
            }
            
            if (nextStep === 'complete') {
                addMessage("Thank you! Your estimate is complete. You can review the details on the right.");
                document.getElementById('inputOptions').innerHTML = '';
                updateCostEstimate();
                return;
            }
            
            // Check if next step exists
            if (!nextStep || !window.CONVERSATION_FLOW[nextStep]) {
                console.error('Invalid next step:', nextStep);
                addMessage("Sorry, there was an issue. Let me restart.");
                conversationState.currentStep = 'initial';
                initializeConversation();
                return;
            }
            
            // Update current step
            conversationState.currentStep = nextStep;
            updateProgress(); // calls the progress update

            // Determine if question also has a response
            const hasResponse = currentStepConfig && currentStepConfig.responseLogic;
            const nextQuestionDelay = hasResponse ? 1500 : 100; //Wait longer if we show a response
            
            // Get next step configuration
            const stepConfig = window.CONVERSATION_FLOW[nextStep];

            if (stepConfig) {
                setTimeout(() => {
                // handle statement display and timing
                if (stepConfig.statementTiming === 'before') {
                    // statement first
                    displayStatement(stepConfig.statement, () => {
                        /*if (stepConfig.question) {
                            addMessage(stepConfig.question);
                        }*/

                        if (stepConfig.question) {
                            let questionText;
                            if (typeof stepConfig.question === 'function') {
                                questionText = stepConfig.question();  // ‚Üê Call the function
                            } else {
                                questionText = stepConfig.question;    // ‚Üê Use string directly
                            }
                            addMessage(questionText);
                        }

                        const inputDelay = (stepConfig.inputType === 'multiSelectGallery' || stepConfig.inputType === 'gallery')
                            ? 1500 // longer delay for galleries
                            : window.CONVERSATION_TIMING.statementDelay; // Normal delay for other inputs

                        console.log('üïê Input type:', stepConfig.inputType, 'Delay:', inputDelay + 'ms'); // ‚Üê Add this

                        setTimeout(() => showInputs(stepConfig), inputDelay);

                        /*setTimeout(() => showInputs(stepConfig), window.CONVERSATION_TIMING.statementDelay);*/
                    });
                } else if (stepConfig.statementTiming === 'after') {

                    // Question first, then statement
                    /*if (stepConfig.question) {
                        addMessage(stepConfig.question);
                    }*/

                    if (stepConfig.question) {
                        let questionText;
                        if (typeof stepConfig.question === 'function') {
                            questionText = stepConfig.question();  // ‚Üê Call the function
                        } else {
                            questionText = stepConfig.question;    // ‚Üê Use string directly
                        }
                        addMessage(questionText);
                    }

                    const inputDelay = (stepConfig.inputType === 'multiSelectGallery' || stepConfig.inputType === 'gallery')
                            ? 1500 // longer delay for galleries
                            : window.CONVERSATION_TIMING.statementDelay;
                    console.log('üïê Input type:', stepConfig.inputType, 'Delay:', inputDelay + 'ms');

                    setTimeout(() => {
                        showInputs(stepConfig);
                        displayStatement(stepConfig.statement, () => {});
                    }, inputDelay);

                } else if (stepConfig.inputType === 'continue') {
                    // Information-only step
                    displayStatement(stepConfig.statement, () => {
                        setTimeout(() => updateContinueInput(), window.CONVERSATION_TIMING.continueButtonDelay);
                    });
                } else {
                    // No statement, just question
                    /*if (stepConfig.question) {
                        addMessage(stepConfig.question);
                    }*/
                    if (stepConfig.question) {
                        let questionText;
                        if (typeof stepConfig.question === 'function') {
                            questionText = stepConfig.question();  // ‚Üê Call the function
                        } else {
                            questionText = stepConfig.question;    // ‚Üê Use string directly
                        }
                        addMessage(questionText);
                    }

                    const inputDelay = (stepConfig.inputType === 'multiSelectGallery' || stepConfig.inputType === 'gallery')
                            ? 1500 // longer delay for galleries
                            : window.CONVERSATION_TIMING.statementDelay;
                    console.log('üïê Input type:', stepConfig.inputType, 'Delay:', inputDelay + 'ms');

                    setTimeout(() => showInputs(stepConfig), inputDelay);

                }
              }, nextQuestionDelay);   
            }            
            updateCostEstimate();
        }

        // Show sticky question for galleries only
        function showStickyQuestionForGallery(questionText) {
            const stickyQuestion = document.getElementById('currentQuestion');
            if (stickyQuestion && questionText) {
                stickyQuestion.textContent = questionText;
                stickyQuestion.classList.remove('hidden');
            }
        }

        // Hide sticky question
        function hideStickyQuestion() {
            const stickyQuestion = document.getElementById('currentQuestion');
            if (stickyQuestion) {
                stickyQuestion.classList.add('hidden');
            }
        }
            
        function showInputs(stepConfig) {
          if (stepConfig.inputType === 'choice') {
            updateInputOptions(stepConfig.options.map(option => ({
              text: option,
              value: option
            })));
          } else if (stepConfig.inputType === 'number') {
            updateNumberInput(stepConfig.validation);
          } else if (stepConfig.inputType === 'gallery') {
            // show sticky question
            const lastMessage = document.querySelector('.message:last-child .message-bubble');
            if (lastMessage) {
                showStickyQuestionForGallery(lastMessage.textContent);
            }
            updateGalleryInput(stepConfig.options);
          } else if (stepConfig.inputType === 'continue') {
            updateContinueInput();
          } else if (stepConfig.inputType === 'multiSelect') {
            updateMultiSelectInput(stepConfig.options);
          } else if (stepConfig.inputType === 'multiSelectGallery') {
            // Show sticky question for multi-select gallery
            const lastMessage = document.querySelector('.message:last-child .message-bubble');
            if (lastMessage) {
                showStickyQuestionForGallery(lastMessage.textContent);
            }
            updateMultiSelectGallery(stepConfig.options);
          } else if (stepConfig.inputType === 'email') {
            updateEmailInput(stepConfig.validation);
          }
        }

      

        /*------------------ GALLERY -------------------*/

        function createGalleryCard(option) { 
            // individual gallery card
            // returns clickable element that triggers selection

            const card = document.createElement('div');
            card.className = 'gallery-card';

            const image = document.createElement('img');
            image.src = option.thumbnail || option.image;
            image.alt = option.name;
            image.className = 'card-image';

            const content = document.createElement('div'); // card content?
            content.className = 'card-content';
            
            const title = document.createElement('div'); // card title
            title.textContent = option.name;
            title.className = 'card-title';

            const description = document.createElement('div');
            description.textContent = option.description || '';
            description.className = 'card-description';

            content.appendChild(title);
            if (option.description) {
                content.appendChild(description);
            }

            card.appendChild(image);
            card.appendChild(content)

            //click handler
            card.onclick = () => selectGalleryOption(option.name, card);

            return card;

        }

        function updateGalleryInput(options) {

            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            inputOptions.style.display = 'none';

            // Enable gallery mode for full height
            //const conversationFlow = document.getElementById('inputOptions');
            

            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.add('gallery-mode');

            const galleryOverlay = document.createElement('div');
            galleryOverlay.id = 'galleryOverlay';
            /*galleryOverlay.style.width = '100%';
            galleryOverlay.style.padding = '1rem';
            galleryOverlay.style.backgroundColor = '#f8f9ff';
            galleryOverlay.style.borderRadius = '8px';
            galleryOverlay.style.marginTop = '1rem';*/

            // Ensure the container can expand
            //inputOptions.style.display = 'block'; // Override any flex settings
            //inputOptions.style.width = '100%';

            const galleryContainer = document.createElement('div');
            // galleryContainer.className = 'gallery-container';
            /*galleryContainer.style.display = 'grid';
            galleryContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(180px, 1fr))';
            galleryContainer.style.gap = '1rem';
            galleryContainer.style.padding = '0 .5rem 0';
            galleryContainer.style.width = '100%';*/

            //check for single column layout
            const currentStep = window.CONVERSATION_FLOW[conversationState.currentStep];
            if (currentStep && currentStep.layout === 'single-column') {
                console.log('üé® Using single-column layout');
                galleryContainer.className = 'gallery-container-single';
                // CSS classes handle grid layout
            } else {
                console.log('üé® Using default multi-column layout');
                //galleryContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(180px, 1fr))';
                galleryContainer.className = 'gallery-container';
            }

            options.forEach(option => {
                const card = createGalleryCard(option);
                galleryContainer.appendChild(card);
            });

            // Add instructions
            const instructions = document.createElement('div');

            // Current step's key name
            const currentStepStr = conversationState.currentStep
                .replace(/_/g, ' ')                         // underscores ‚Üí spaces
                .replace(/\b\w/g, l => l.toUpperCase());    // capitalize each word

            instructions.textContent = `Select 1 choice for ${currentStepStr}`  
            //'Select a material option below';
           /* instructions.style.marginBottom = '1rem';
            instructions.style.fontWeight = '600';
            instructions.style.color = '#2c3e50';*/

            galleryOverlay.appendChild(instructions);
            galleryOverlay.appendChild(galleryContainer);
            conversationFlow.appendChild(galleryOverlay);

            //scroll to gallery
            setTimeout(() => {

                // Scroll to gallery instructions, not the bottom
                const instructions = galleryOverlay.querySelector('.gallery-instructions');
                if (instructions){
                    instructions.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                } else {
                    // Fallback scroll to gallery container itself
                    galleryOverlay.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }

                //galleryOverlay.scrollIntoView({ behavior: 'smooth' });
                flashInputOptions(); // Flash the input area
            }, 100);

            //inputOptions.appendChild(galleryContainer);
            //setTimeout(() => flashInputOptions(), 50);

            /*updateInputOptions(options.map(option => ({
                text: option.name || option,
                value: option.name || option
            })));*/
        }

        function selectGalleryOption(optionName, cardElement) {
            //handles selection of gallery element with visual feedback
            //highlights selected card and proceeds with conversation

            // DEBUG: Check what we're getting
            console.log('selectGalleryOption called with:', optionName);
            console.log('Type of optionName:', typeof optionName);

            // Find the full option object with img URL form config
            const currentStep = window.CONVERSATION_FLOW[conversationState.currentStep];
            const fullOption = currentStep.options.find(opt => opt.name === optionName);

            //store name and image systematically
            window.tempGallerySelection = {
                name: optionName,
                image: fullOption ? fullOption.image : null,
                thumbnail: fullOption ? fullOption.thumbnail : null,
                description: fullOption ? fullOption.description : null
            };

            console.log('Stored full option:', window.tempGallerySelection);

            // Remove previous selections
            document.querySelectorAll('.gallery-card').forEach(card => {
                card.classList.remove('selected');

                // remove checkmark
                removeSelectionCheckmark(card);
            });

            //highlight selected card
            cardElement.classList.add('selected');
            addSelectionCheckmark(cardElement);



            //disable all cards to prevent double-click
            /* document.querySelectorAll('.gallery-card').forEach(card => {
                card.style.pointerEvents = 'none';
                if (!card.classList.contains('selected')) {
                    card.style.opacity = '0.6';
                }
            });*/

            //proceed with selection
            showGalleryConfirmButton(optionName);
        }

        function showGalleryConfirmButton(chosenOption) {

            console.log('showGalleryConfirmButton called with:', chosenOption);
            console.log('Type of chosenOption:', typeof chosenOption);

            // Shows confirm button for gallery selection
            // Allows user to confirm choice before proceeding

            // Remove existin confirm button if any
            const existingButton = document.getElementById('galleryConfirmButton');
            if (existingButton) {
                existingButton.remove();
            }

            const galleryOverlay = document.getElementById('galleryOverlay');
            if (!galleryOverlay) return;

            const confirmContainer = document.createElement('div');
            confirmContainer.id = 'galleryConfirmButton';


            /*const selectionText = document.createElement('div');

            // DEBUG: Test different ways of setting the text
            const testText = 'You selected: ' + chosenOption;
            console.log('testText variable:', testText);

            selectionText.textContent = 'You selected:' + chosenOption;
            console.log('selectionText.textContent after setting:', selectionText.textContent);
            selectionText.style.marginBottom = '1rem';
            selectionText.style.fontWeight = '600';
            selectionText.style.color = '#2c3e50';*/

            const confirmButton = document.createElement('button');
            confirmButton.className = 'option-button primary';
            confirmButton.textContent = 'Confirm Selection';

            confirmButton.onclick = () => confirmGallerySelection();

            /*confirmContainer.appendChild(selectionText);*/
            confirmContainer.appendChild(confirmButton);
            galleryOverlay.appendChild(confirmContainer);

            // Scroll to confirm button
            setTimeout(() => {
                const conversationFlow = document.getElementById('conversationFlow');
                conversationFlow.scrollTop = conversationFlow.scrollHeight;
                // confirmButton.scrollIntoView({ behavior: 'smooth', block: 'center'});
            }, 300);
        }

        function confirmGallerySelection() {
            // Finallizes gallery selection and proceeds with conversation
            // Cleans up Gallery overlay and restores normal input area

            hideStickyQuestion(); // Clear sticky question

            const selectedOptionData = window.tempGallerySelection;
            if (!selectedOptionData || !selectedOptionData.name) return;

            console.log('Confirming selection:', selectedOptionData);

            // Remove gallery overlay
            const galleryOverlay = document.getElementById('galleryOverlay');
            if (galleryOverlay) {
                galleryOverlay.remove();
            }

            // Restore normal conversation-flow height
            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.remove('gallery-mode');

            // Restore input options area
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.style.display = 'flex';

            // Get current step config for user response template
            const stepConfig = window.CONVERSATION_FLOW[conversationState.currentStep];
            let displayMessage = selectedOptionData.name;
            if (stepConfig && stepConfig.userResponseTemplate) {
                displayMessage = stepConfig.userResponseTemplate.replace('{selection}', selectedOptionData.name);
            }

            // custom message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';

            // create message bubble w/text only
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble';
            messageBubble.innerHTML = displayMessage;

            // 
            const imageCard = document.createElement('div');
            imageCard.className = 'user-image-card';

            const img = document.createElement('img');
            img.src = selectedOptionData.thumbnail || selectedOptionData.image;
            img.alt = selectedOptionData.name;
            img.className = 'user-image-card-img';

            const cardContent = document.createElement('div');
            cardContent.className = 'user-image-card-content';

            const cardTitle = document.createElement('div');
            cardTitle.className = 'user-image-card-title';
            cardTitle.textContent = selectedOptionData.name;

            if(selectedOptionData.description) {
                const cardDescription = document.createElement('div');
                cardDescription.className = 'user-image-card-description';
                cardDescription.textContent = selectedOptionData.description;
                cardContent.appendChild(cardTitle);
                cardContent.appendChild(cardDescription)
            } else {
                cardContent.appendChild(cardTitle);
            }

            imageCard.appendChild(img);
            imageCard.appendChild(cardContent);


            // Assemble the message
            messageDiv.appendChild(messageBubble);
            messageDiv.appendChild(imageCard);
            conversationFlow.appendChild(messageDiv);

            // Add user message with image from stored data
            /*const imageUrl = selectedOptionData.thumbnail || selectOptionData.image;
            addMessage(selectedOptionData.name, 'user', imageUrl);*/

            // Store selection in session data (just the name for flow logic)
            conversationState.sessionData[conversationState.currentStep] = selectedOptionData.name;

            // Store complete option data for future use
            conversationState.sessionData[conversationState.currentStep + '_fullData'] = selectedOptionData;

            // Clear temp selection
            delete window.tempGallerySelection;

            // Proceed with the selection
            //selectOption(selectedOption);

            // Continue conversation
            setTimeout(() => {
                progressConversation(selectedOptionData.name);
                const conversationFlow = document.getElementById('conversationFlow');
                conversationFlow.scrollTop = conversationFlow.scrollHeight;
            }, 500);

        }

        function updateMultiSelectInput(options) {
            // Creates multi-select pill button with confirm workflow
            // Allows multiple selections before proceeding

            console.log('updateMultiSelectInput called with:', options);
            console.log('Options array contents:', JSON.stringify(options, null, 2));

            const inputOptions = document.getElementById('inputOptions');

            console.log('inputOptions element:', inputOptions);
            console.log('inputOptions style object:', inputOptions.style);

            if (!inputOptions) {
                console.error('inputOptions element not found!');
                return;
            }

            // Clear the content
            try {
                inputOptions.innerHTML = '';
                console.log('innerHTML cleared successfully');
            } catch (error) {
                console.error('Error clearing innerHTML:', error);
                return;
            }

            // Try to access the style property that's failing
            try {
                inputOptions.style.display = 'flex';
                console.log('Style.display set successfully');
            } catch (error) {
                console.error('Error setting style.display:', error);
                return;
            }

            inputOptions.innerHTML = '';

            // Initialize selection tracking
            window.tempMultiSelections = [];

            if (!inputOptions) {
                console.error('inputOptions element not found!');
                return;
            }

            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexWrap = 'wrap';
            container.style.gap = '0.5rem';
            container.style.marginBottom = '1rem';

            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button multi-select-button primary';
                button.textContent = option;
                button.onclick = () => toggleMultiSelect(option, button);
                container.appendChild(button);
            });

            // Add continue button (initially disabled)
            const continueButton = document.createElement('button');
            continueButton.id = 'multiSelectContinue';
            continueButton.className = 'option-button';
            continueButton.textContent = 'Continue';
            continueButton.disabled = true;
            continueButton.onclick = () => confirmMultiSelect();

            // Skip button
            const skipButton = document.createElement('button');
            skipButton.className = 'option-button skip';
            skipButton.textContent = 'Skip';
            skipButton.onclick = () => skipMultiSelect;

            inputOptions.appendChild(container);
            inputOptions.appendChild(continueButton);
            inputOptions.appendChild(skipButton);

            setTimeout(() => flashInputOptions(), 50);

        }

        // needs to go before updateMultiSelectGallery

        function createMultiSelectGalleryCard(option) {
            // Creates gallery card for multi-select using CSS classes
            // Returns clickable card that can be selected/deselected

            const card = document.createElement('div');
            card.className = 'multi-select-gallery-card';

            const image = document.createElement('img');
            image.src = option.thumbnail || option.image;
            image.alt = option.name;
            image.className = 'card-image';

            const content = document.createElement('div');
            content.className = 'card-content';

            const title = document.createElement('div');
            title.textContent = option.name;
            title.className = 'card-title';

            const description = document.createElement('div');
            description.textContent = option.description || '';
            description.className = 'card-description';

            content.appendChild(title);
            if (option.description) {
                content.appendChild(description);
            }

            card.appendChild(image);
            card.appendChild(content);

            // click handler for multi-select
            card.onclick = () => toggleMultiSelectGallery(option, card);

            return card;
        }

        function updateMultiSelectGallery(options) {
            // creates multi select gallery with image cards and confirm workflow
            // Allows multiple image selections before proceeding

            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            inputOptions.style.display = 'none';

            // Initialize selection tracking
            window.tempMultiSelections = [];

            // Enable gallery mode for full height
            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.add('gallery-mode');

            const galleryOverlay = document.createElement('div');
            galleryOverlay.id = 'multiSelectGalleryOverlay';
            galleryOverlay.className = 'multi-select-gallery-overlay';
           

            const instructions = document.createElement('div');
            instructions.textContent = 'Choose all that apply';
            instructions.className = 'multi-select-gallery-instructions';

            const galleryContainer = document.createElement('div');
            galleryContainer.className = 'multi-select-gallery-container'

            options.forEach(option => {
                const card = createMultiSelectGalleryCard(option);
                galleryContainer.appendChild(card);
            });

            // Add button container
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.flexDirection = 'row';
            buttonContainer.style.gap = '0.5rem';

            // Add continue button
            const continueButton = document.createElement('button');
            continueButton.id = 'multiSelectGalleryContinue';
            continueButton.className = 'option-button continue-button';
            continueButton.textContent = 'Continue';
            // continueButton style
            continueButton.disabled = true;
            //continueButton.onclick = () => confirmMultiSelectGallery();

            continueButton.onclick = () => {
                console.log('Continue button clicked!');  // ‚Üê Add this
                confirmMultiSelectGallery();
            };

            // Skip button
            const skipButton = document.createElement('button');
            skipButton.className = 'option-button skip';
            skipButton.textContent = 'Skip';
            skipButton.onclick = () => skipMultiSelectGallery();

            // buttons into buttonContainer
            buttonContainer.appendChild(continueButton);
            buttonContainer.appendChild(skipButton);

            galleryOverlay.appendChild(instructions);
            galleryOverlay.appendChild(galleryContainer);

            // buttonContainer into overlay
            galleryOverlay.appendChild(buttonContainer);
            conversationFlow.appendChild(galleryOverlay);

            /*galleryOverlay.appendChild(continueButton);
            galleryOverlay.appendChild(skipButton);*/
            
            setTimeout(() => {
                // Scroll so gallery instructions appears just below the last message
                const instruction = galleryOverlay.querySelector('.multi-select-gallery-instructions');
                if (instructions) {
                    instructions.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start' // Align top of viewport
                    });
                }

                /*const conversationFlow = document.getElementById('conversationFlow');
                conversationFlow.scrollTop = conversationFlow.scrollHeight;*/
                flashInputOptions();
            }, 100);
        }

        function skipMultiSelect() {
            console.log('skipMultiSelect called');
            window.tempMultiSelections = [];
            addMessage('Skipped', 'user');
            conversationState.sessionData[conversationState.currentStep] = [];
            setTimeout(() => {
                progressConversation([]);
            }, 500);
        }

        function skipMultiSelectGallery() {
            console.log('skipMultiSelectGallery called');
            hideStickyQuestion();
            window.tempMultiSelections = [];

            const galleryOverlay = document.getElementById('multiSelectGalleryOverlay');
            if (galleryOverlay) galleryOverlay.remove();

            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.remove('gallery-mode');

            const inputOptions = document.getElementById('inputOptions');
            inputOptions.style.display = 'flex';

            addMessage('Skipped', 'user');
            conversationState.sessionData[conversationState.currentStep] = [];
            conversationState.sessionData[conversationState.currentStep + '_fullData'] = [];

            delete window.tempMultiSelections;

            setTimeout(() => {
                progressConversation([]);
                conversationFlow.scrollTop = conversationFlow.scrollHeight;
            }, 500);
        }

        function toggleMultiSelect(option, buttonElement) {
            // Toggles selected state for multi-select pill buttons
            // Updates visual state and enables / disables continue button

            const index = window.tempMultiSelections.indexOf(option);

            if (index === -1) {
                // Add selection
                window.tempMultiSelections.push(option);
                buttonElement.classList.add('selected');

            } else {
                // Remove selection
                window.tempMultiSelections.splice(index, 1);
                buttonElement.classList.remove('selected');
            }

            updateMultiSelectContinueButton();

        }

        function toggleMultiSelectGallery(option, cardElement) {
            // Toggles selection state for multi-select gallery cards
            // Updates visual state and enables/disables continue button

            console.log('toggleMultiSelectGallery called with:', option.name);

            const index = window.tempMultiSelections.findIndex(item => item.name === option.name);

            if (index === -1) {
                // Add selection
                window.tempMultiSelections.push(option);
                cardElement.classList.add('selected');

                // Add checkmark
                addSelectionCheckmark(cardElement);

            } else {

                // Remove selection
                window.tempMultiSelections.splice(index, 1);
                cardElement.classList.remove('selected');
                /*cardElement.style.borderColor = '#e5e5e5';
                cardElement.style.backgroundColor = 'white';
                cardElement.style.transform = 'translateY(0)';
                cardElement.style.boxShadow = 'none';*/

                // remove checkmark
                removeSelectionCheckmark(cardElement);
            }
            console.log('About to call updateMultiSelectContinueButton');  // ‚Üê Add this
            updateMultiSelectContinueButton();
        }

        function updateMultiSelectContinueButton() {
            // Enables/disables continue button based on selections
            // Updates button styling and interaction state

            const continueButton = document.getElementById('multiSelectContinue') || document.getElementById('multiSelectGalleryContinue');

            if (continueButton) {
                if (window.tempMultiSelections.length > 0) {
                    continueButton.disabled = false;
                    continueButton.textContent = `Continue (${window.tempMultiSelections.length} selected)`;

                } else {
                    continueButton.disabled = true;
                    continueButton.textContent = 'Continue';

                }
            }
        }

        function addSelectionCheckmark(cardElement) {
            // Adds visual checkmark to selected gallery cards
            const checkmark = document.createElement('div');
            checkmark.className = 'selection-checkmark';
            checkmark.innerHTML = '‚úì';

            cardElement.appendChild(checkmark);

        }

        function removeSelectionCheckmark(cardElement) {
            // Removes visual checkmark from deselected gallery cards
            const checkmark = cardElement.querySelector('.selection-checkmark');
            if (checkmark) {
                checkmark.remove();
            }
        }

        function confirmMultiSelect() {
            // Finalizes the multi-select pill button functions
            // Proceeds with conversation using selected options



            if (!window.tempMultiSelections || window.tempMultiSelections.length === 0) return;

            console.log('Multi-select confirmed:', window.tempMultiSelections);

            // Add user message showing selections
            const selectionText = window.tempMultiSelections.join(', ');
            addMessage(selectionText, 'user');

            // Store selections in session data
            conversationState.sessionData[conversationState.currentStep] = window.tempMultiSelections;

            delete window.tempMultiSelections;

            // Continue conversation
            setTimeout(() => {
                progressConversation(selectionText);
            }, 500);
        }

        function confirmMultiSelectGallery() {
            // Finalizes multi-select gallery selections with images
            // Shows selected images in conversation and procceds

            hideStickyQuestion(); // Clear sticky questiuon

            console.log('üöÄ confirmMultiSelectGallery called!');  // ‚Üê Add this
            console.log('üöÄ tempMultiSelections:', window.tempMultiSelections);  // ‚Üê Add this

            //if (!window.tempMultiSelections || window.tempMultiSelections.length === 0 ) return;

            if (!window.tempMultiSelections || window.tempMultiSelections.length === 0 ) {
                console.log('üö® No selections, returning early');  // ‚Üê Add this
                return;
              }

            console.log('Multi-select gallery confirmed:', window.tempMultiSelections);

            // Remove Overlay gallery
            const galleryOverlay = document.getElementById('multiSelectGalleryOverlay');
            if (galleryOverlay) {
                galleryOverlay.remove();
            }

            // Restore normal conversation flow height
            const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.remove('gallery-mode');

            // Restore input options area
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.style.display = 'flex';

            // create single message with all selections and images
            const selectionNames = window.tempMultiSelections.map(item => item.name || item);
            const selectionText = selectionNames.join(', ');

            // Get template if available
            const stepConfig = window.CONVERSATION_FLOW[conversationState.currentStep];

            // Orig

            /*let displayMessage = selectionText;
            if (stepConfig && stepConfig.userResponseTemplate) {
                displayMessage = stepConfig.userResponseTemplate.replace('{selection}', selectionText);
            }*/

            // Updated

            console.log('Called confirmMultiSelectGallery', stepConfig);
            // Only show user message if user response template exists
            // if(stepConfig && stepConfig.userResponseTemplate) {

            // FIX THIS

            const formattedOptions = formatOptions(selectionNames);
            const displayMessage = stepConfig.userResponseTemplate.replace('{selection}', formattedOptions);

            // Create custom messages with text and image grid
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';

            // Create message bubble
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble';
            messageBubble.innerHTML = displayMessage;

            // Create image grid
            const imageGrid = document.createElement('div');
            imageGrid.className = 'multi-select-image-card';

            window.tempMultiSelections.forEach(selection => {
                const imageUrl = selection.thumbnail || selection.image;
                const name = selection.name || selection;

                const gridItem = document.createElement('div');
                gridItem.className = 'grid-image-item';

                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = name;
                img.className = 'grid-image';

                const label = document.createElement('span');
                label.className = 'grid-image-label';
                label.textContent = name;

                gridItem.appendChild(img);
                gridItem.appendChild(label);
                imageGrid.appendChild(gridItem);
            });

            // Assemble the message
            messageDiv.appendChild(messageBubble);
            messageDiv.appendChild(imageGrid);
            conversationFlow.appendChild(messageDiv);

            // Create message content within image and grid
            /*messageDiv.innerHTML = `
                <div class="message-bubble">${displayMessage}</div>
                <div class="multi-select-image-grid">
                    ${window.tempMultiSelections.map(selection => {
                        const imageUrl = selection.thumbnail || selection.image;
                        const name = selection.name || selection;
                        return `<div class="grid-image-item">
                            <img src="${imageUrl}" alt="${name}" class="grid-image">
                            <span class="grid-image-label">${name}</span>
                        </div>`;
                        }).join('')}
                    </div>
                `;*/

            //conversationFlow.appendChild('messageDiv');

            // store data and continue
            conversationState.sessionData[conversationState.currentStep] = selectionNames;
            conversationState.sessionData[conversationState.currentStep + '_fullData'] = window.tempMultiSelections;


            // Add user message for each selection with images
           /* window.tempMultiSelections.forEach(selection => {
                const imageUrl = selection.thumbnail || selection.image;
                const name = selection.name || selection;
                addMessage(name, 'user', imageUrl);
            });

            // Store selections in session data (just names for flow logic)
            const selectionNames = window.tempMultiSelections.map(item => item.name || item);
            conversationState.sessionData[conversationState.currentStep] = selectionNames;

            // Add this debug:
            console.log('Stored session data:', conversationState.sessionData);
            console.log('Current cost items:', conversationState.costItems);

            // Store complete selection data*/
            

            // Clear temp selections
            delete window.tempMultiSelections;

            // Continue conversation

            console.log('üöÄ About to call progressConversation with:', selectionNames);  // ‚Üê Add this
            setTimeout(() => {
                progressConversation(selectionNames); // passing an array
                const conversationFlow = document.getElementById('conversationFlow');
                conversationFlow.scrollTop = conversationFlow.scrollHeight;
            }, 500);

        }

        

        function updateNumberInput(validation) {

            // Creates a number input field with validation rules and error handling
            // Displays input field, submit button, and error message container


            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            
            const inputContainer = document.createElement('div');
            inputContainer.style.display = 'flex';
            inputContainer.style.gap = '0.5rem';
            inputContainer.style.alignItems = 'center';

            const inputRow = document.createElement('div');
            inputRow.style.display = 'flex';
            inputRow.style.gap = '0.5rem';
            inputRow.style.alignItems = 'center';
            
            const numberInput = document.createElement('input');
            numberInput.className = 'number-input';
            numberInput.type = 'text';
            numberInput.placeholder = validation ? `${validation.min} - ${validation.max} sq ft` : 'Enter square footage';
            /* numberInput.style.padding = '0.5rem';
            numberInput.style.border = '2px solid #2196f3';
            numberInput.style.borderRadius = '8px';
            numberInput.style.fontSize = '1rem';
            numberInput.style.flex = '1';*/
            
            /* if (validation) {
                numberInput.min = validation.min;
                numberInput.max = validation.max;
            }*/

            // asked me to remove ^^
            
            const submitButton = document.createElement('button');
            submitButton.className = 'option-button primary';
            submitButton.textContent = 'Continue';
            submitButton.onclick = () => handleNumberSubmit(numberInput, validation);


            /*submitButton.onclick = () => {
                const value = numberInput.value;
                if (value && (!validation || (value >= validation.min && value <= validation.max))) {
                    selectOption(value);
                } else {
                    alert(`Please enter a number between ${validation.min} and ${validation.max}`);
                }
            };*/

            // asked me to remove ^^

            //error message
            const errorMessage = document.createElement('div');
            errorMessage.id = 'numberInputError';
            errorMessage.style.color = '#e74c3c';
            errorMessage.style.fontSize = '0.9rem';
            errorMessage.style.display = 'none';

            //realtime validation
            numberInput.addEventListener('input', () => clearNumberError());
            numberInput.addEventListener('keypress', (e) => handleNumberKeypress(e, numberInput, validation));
            
            /*inputContainer.appendChild(numberInput);
            inputContainer.appendChild(submitButton);
            inputOptions.appendChild(inputContainer);*/

            // asked me to remove ^^

            inputRow.appendChild(numberInput);
            inputRow.appendChild(submitButton);
            inputContainer.appendChild(inputRow);
            inputContainer.appendChild(errorMessage);
            inputOptions.appendChild(inputContainer);

            // Flash to indicate new input is available
            setTimeout(() => flashInputOptions(), 50);
            setTimeout(() => numberInput.focus(), 100);
            
            setTimeout(() => numberInput.focus(), 100);
        }

        function updateProgress() {
            const roomType = conversationState.sessionData.initial;
            const currentStep = conversationState.currentStep;

            if(!roomType) return;

            const progressInfo = window.ProgressCalculator.getProgressInfo(
                roomType,
                currentStep,
                conversationState.sessionData
            );

            // Update UI
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            if(progressFill && progressText) {
                // Animate progress bar
                progressFill.style.width = `${progressInfo.progressPercent}%`;

                // Update with dynamic info
                /*progressText.textContent = 
                    `Step ${progressInfo.currentStep} of ${progressInfo.totalSteps} ‚Ä¢ ${progressInfo.progressPercent}% Complete`;*/

                progressText.textContent = 
                    `${progressInfo.progressPercent}% Complete`;

                // Add completion styling
                if (progressInfo.isComplete) {
                    progressFill.classList.add('complete');
                    progressText.textContent = 'Complete!';
                }
            }

            // Debug info
            console.log('Dyanmic Progress', progressInfo);
        }

        /* ------- STYLE FUNCTIONS ------------*/

        function flashInputOptions() {
            // Highlights the input options area with fast flash and slow fade
            // Provides visual feedback that new choices are available
            const inputOptions = document.getElementById('inputOptions');
            if (!inputOptions) return;
            
            const originalBackground = inputOptions.style.backgroundColor || '';
            const flashColor = '#FFCEBF'; // Light rust system color
            
            // Fast flash (100ms)
            inputOptions.style.transition = 'background-color 100ms ease-out';
            inputOptions.style.backgroundColor = flashColor;
            
            // Then slow fade back to original (1000ms)
            setTimeout(() => {
                inputOptions.style.transition = 'background-color 1000ms ease-in-out';
                inputOptions.style.backgroundColor = originalBackground;
            }, 100);
        }

        /* ------- NUMBER INPUT FUNCTIONS ------------*/

        // added funtion
        function handleNumberSubmit(inputElement, validation) {

            // Validates user input and submits if valid, shows error if invalid
            // Checks for empty values, non-numeric characters, and range validation

            // Disable submit button to prevent double submission
            const submitButton = inputElement.parentElement.querySelector('.option-button');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.style.opacity = '0.6';
                submitButton.textContent = 'Thinking...';
            }

            const value = inputElement.value.trim();
            
            // Check if empty
            if (!value) {
                showNumberError('Please enter a value');
                return;
            }
            
            // Check if contains only digits
            if (!isValidNumber(value)) {
                showNumberError('Please enter only numbers');
                return;
            }
            
            const numValue = parseInt(value);
            
            // Check validation range
            if (validation && (numValue < validation.min || numValue > validation.max)) {
                showNumberError(`Please enter a number between ${validation.min} and ${validation.max}`);

                //Re-enable button on error
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                    submitButton.textContent = 'Continue';
                }

                return;
            }
            
            // All good, proceed
            selectOption(value);
        }

        function isValidNumber(value) {

            // Returns true if input contains only digits, commas, and spaces
            // Allows formatted numbers like "1,200" or "1 200" but rejects letters

            // Check if string contains only digits (and optionally spaces/commas)
            const digitPattern = /^[\d,\s]+$/;
            if (!digitPattern.test(value)) {
                return false;
            }
            
            // Remove commas and spaces, then check if it's a valid number
            const cleanValue = value.replace(/[,\s]/g, '');
            return !isNaN(cleanValue) && cleanValue !== '';
        }  
        
        function showNumberError(message) {

            // Displays error message and adds red border to input field
            // Makes validation feedback visible to user with styling changes

            const errorElement = document.getElementById('numberInputError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                // Add red border to input
                const input = errorElement.parentElement.querySelector('input');
                if (input) {
                    input.style.borderColor = '#e74c3c';
                }
            }
        }      

        function clearNumberError() {

            // Hides error message and resets input field border to normal
            // Called when user starts typing to clear previous error state

            const errorElement = document.getElementById('numberInputError');
            if (errorElement) {
                errorElement.style.display = 'none';
                
                // Reset border color
                const input = errorElement.parentElement.querySelector('input');
                if (input) {
                    // input.style.borderColor = '#2196f3';
                    input.style.cssText = `
                        border-color: var(--neutral-500);
                    `;
                }
            }
        }

        function handleNumberKeypress(event, inputElement, validation) {

            // Prevents non-numeric characters from being typed in real-time
            // Allows Enter to submit, digits/commas/spaces, but blocks letters instantly

            // Allow Enter key to submit
            if (event.key === 'Enter') {
                event.preventDefault();
                handleNumberSubmit(inputElement, validation);
                return;
            }
            
            // Allow backspace, delete, tab, escape, and arrow keys
            if ([8, 9, 27, 37, 38, 39, 40, 46].includes(event.keyCode)) {
                return;
            }
            
            // Allow commas and spaces for formatting
            if (event.key === ',' || event.key === ' ') {
                return;
            }
            
            // Only allow digits
            if (!/[0-9]/.test(event.key)) {
                event.preventDefault();
            }
        }

        // Update input options
        function updateInputOptions(options) {
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option.text;
                button.onclick = () => selectOption(option.value);
                inputOptions.appendChild(button);
            });

            // Flash to indicate new options are available
            setTimeout(() => flashInputOptions(), 50);
        }

        // Should prices be shown
        function shouldShowPrices() {
            const urlParams = new URLSearchParams(window.location.search);
            const result = urlParams.get('bypass') === 'testing123';
            console.log('üìä shouldShowPrices - URL params:', urlParams.toString(), 'Result:', result);
            return result;
        }






        /*--------  EmailJS  --------*/


        async function sendEstimateEmails(customerEmail) {

            try {
                console.log('Preparing to send emails to', customerEmail);

                // Gather the estimate data
                const estimateData = generateEstimateData(customerEmail);

                console.log('üìã Full estimate data being sent:');
                console.log(JSON.stringify(estimateData, null, 2));  // ‚Üê Add this debug

                console.log('Estimate data prepared', estimateData);

                // Prepare customer email data
                const customerEmailData = {
                    ...estimateData,
                    // Use customer
                    line_items: estimateData.customer_line_items,
                    estimate_min: estimateData.customer_estimate_min,
                    estimate_max: estimateData.customer_estimate_max,
                    estimate_range: estimateData.customer_estimate_range
                };

                // Prepare admin email data (admin_ prefixed fields)
                const adminEmailData = {
                    ...estimateData,
                    line_items: estimateData.admin_line_items,
                    estimate_min: estimateData.admin_estimate_min,
                    estimate_max: estimateData.admin_estimate_max,
                    estimate_range: estimateData.admin_estimate_range
                };

                // Send email to customer
                console.log('Sending email to customer');
                await emailjs.send(
                    'service_ienqmwk', // EmailJS service ID
                    'template_0mza96t', // replace with your customer template ID
                    customerEmailData
                );
                console.log('Customer email sent successfully');

                // Send email to designer
                console.log('SEnding email to designer');
                await emailjs.send(
                    'service_ienqmwk',
                    'template_t3gpybn',
                    adminEmailData
                );

                console.log('üìß Service ID:', 'YOUR_SERVICE_ID');
                console.log('üìß Template IDs:', 'template_customer', 'template_designer');
                console.log('Email sent successfully');

                return { success: true };

            } catch (error) {
                console.error('Email sending failed', error);
                //console.log('üìã Data that failed:', estimateData);  // ‚Üê Add this too
                throw new Error('Failed to send estimate emails');
            }
        }

        function debugEmailData() {
            const data = generateEstimateData(customerEmail);

            console.log('=== CUSTOMER EMAIL (REDACTED) ===');
            console.log(data.customer_line_items);
            console.log('Range:', data.customer_estimate_range);
            
            console.log('=== ADMIN EMAIL (FULL PRICING) ===');
            console.log(data.admin_line_items);
            console.log('Range:', data.admin_estimate_range);
        }

        function generateEstimateData(customerEmail) {
            // Calculate current total estimate
            const { minTotal, maxTotal } = calculateCurrentEstimate();

            // Gather all user selections
            const selections = [];
            Object.keys(conversationState.sessionData).forEach(step => {
                const value = conversationState.sessionData[step];
                if (value && step !== 'initial') {
                    // Format step names nicely
                    const stepName = step
                        .replace(/_/g, ' ')                         // Underscores -> spaces
                        .replace(/\b\w/g, l => l.toUpperCase());    // capitalize each word

                    selections.push(`${stepName}: ${value}`);
                }
            });

            // Detailed line items with redacted prices for email
            const customerLineItems = [];
            let customerRunningTotal = 0;

            // Add always included items to email
            if (window.ALWAYS_INCLUDED) {
                window.ALWAYS_INCLUDED.forEach(item => {
                    const shouldShowPrice = item.showPrice || false;
                    let displayPrice;

                    if (shouldShowPrice) {
                        displayPrice = `$${(item.price || 0).toLocaleString()}`;
                        customerRunningTotal += item.price || 0;
                    } else {
                        displayPrice = '‚Ä¢‚Ä¢‚Ä¢';
                    }

                    customerLineItems.push(`${item.name} - ${displayPrice}`);

                    /*detailedLineItems.push(`${item.name} - $${(item.price || 0).toLocaleString()}`);
                    emailRunningTotal += item.price || 0;*/
                })
            }

            // Add dynamic items for customer
            conversationState.costItems.forEach(item => {
                const price = calculateLineItemPrice(item);
                const shouldShowPrice = item.showPrice || false;
                let displayPrice;

                if (shouldShowPrice && typeof price === 'number'){
                    displayPrice = `$${price.toLocaleString()}`;
                    customerRunningTotal += price;
                } else {
                    displayPrice = '‚Ä¢‚Ä¢‚Ä¢';
                }

                customerLineItems.push(`${item.name} - ${displayPrice}`)

            });

            // Generate ADMIN line items (full pricing)
            const adminLineItems = [];
            let adminRunningTotal = 0;

            if (window.ALWAYS_INCLUDED) {
                window.ALWAYS_INCLUDED.forEach(item => {
                    const price = item.price || 0;
                    adminLineItems.push(`${item.name} - $${price.toLocaleString()}`);
                    adminRunningTotal += price;
                });
            }

            // Add dyanmic items for ADMIN
            conversationState.costItems.forEach(item => {
                const price = calculateLineItemPrice(item);
                const priceStr = typeof price === 'number' ? `$${price.toLocaleString()}` : '‚Ä¢‚Ä¢‚Ä¢';
                adminLineItems.push(`${item.name} - ${priceStr}`);
                if (typeof price === 'number') {
                    adminRunningTotal += price;
                }
            });

            // Calculate customer estimates
            const customerMinTotal = Math.round(customerRunningTotal * 0.8);
            const customerMaxTotal = Math.round(customerRunningTotal * 1.2);

            // Calculate admin estimates (tighter range since they see all details)
            const adminMinTotal = Math.round(adminRunningTotal * 0.95);
            const adminMaxTotal = Math.round(adminRunningTotal * 1.05);

            // return both versions

            return {
                // Common data
                customer_email: customerEmail,
                customer_name: customerEmail.split('@')[0],
                room_type: conversationState.sessionData.initial,
                square_footage: conversationState.sessionData.square_footage,
                project_type: conversationState.sessionData.project_type,
                // flooring: conversationState.sessionData.kitchen_flooring,
                date_submitted: new Date().toLocaleDateString(),
                time_submitted: new Date().toLocaleTimeString(),
                lead_source: 'Studio 74 Estimator Tool',

                selections_list: selections.join('\n'),  // ‚Üê Add this
                //line_items: detailedLineItems.join('\n'), // Detailed breakdown for

                // Customer data - Redacted data
                customer_line_items: customerLineItems.join('\n'),
                customer_estimate_min: `$${customerMinTotal.toLocaleString()}`,
                customer_estimate_max: `$${customerMaxTotal.toLocaleString()}`,
                customer_estimate_range: `$${customerMinTotal.toLocaleString()} - $${customerMaxTotal.toLocaleString()}`,

                // Admin version
                admin_line_items: adminLineItems.join('\n'),
                admin_estimate_min: `$${adminMinTotal.toLocaleString()}`,
                admin_estimate_max: `$${adminMaxTotal.toLocaleString()}`,
                admin_estimate_range: `$${adminMinTotal.toLocaleString()} - $${adminMaxTotal.toLocaleString()}`,
                
                follow_up_priority: adminMaxTotal > 50000 ? 'High' : 'Medium'
            };
        }

        function calculateCurrentEstimate() {
            let runningTotal = 0;

            // Add always included items
            if (window.ALWAYS_INCLUDED) {
                window.ALWAYS_INCLUDED.forEach(item => {
                    runningTotal += item.price || 0;
                });
            }

            // Add current line items
            conversationState.costItems.forEach(item => {
                const calculatedPrice = calculateLineItemPrice(item);
                if (typeof calculatedPrice === 'number') {
                    runningTotal += calculatedPrice;
                }
            });

            // Calculate range
            const minTotal = Math.round(runningTotal * 0.9);
            const maxTotal = Math.round(runningTotal * 1.2);

            return { minTotal, maxTotal };
        }

        /*----------  BYPASS FUNCTION  ------------*/

        document.addEventListener('keydown', function(e) {
            // Ctrl + Shift + B = Bypass
            if (e.ctrlKey && e.shiftKey && e.key === 'B') {
                console.log('üß™ Keyboard bypass activated');
                if (conversationState.currentStep === 'email_capture') {
                    selectOption('test@example.com');
                }
            }
        });



        function updateEmailInput () {
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';

            const inputContainer = document.createElement('div');
            inputContainer.className = 'email-input-container';

            const emailInput = document.createElement('input');
            emailInput.type = 'email';
            emailInput.className = 'email-input';
            emailInput.placeholder = 'youremail@example.com';
            emailInput.required = true;

            const submitButton = document.createElement('button');
            submitButton.className = 'option-button email-submit-button primary';
            submitButton.textContent = 'Send me a detailed estimate';

            submitButton.onclick = () => handleEmailSubmit(emailInput);

            const errorMessage = document.createElement('div');
            errorMessage.id = 'emailInputError';
            errorMessage.className = 'email-error-message';

            // Event listeners
            emailInput.addEventListener('input', () => clearEmailError());
            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleEmailSubmit(emailInput);
                }
            });

            inputContainer.appendChild(emailInput);
            inputContainer.appendChild(submitButton);
            inputContainer.appendChild(errorMessage);
            inputOptions.appendChild(inputContainer);

            setTimeout(() => flashInputOptions(), 50);
            setTimeout(() => emailInput.focus(), 100);
        }

        function showEmailError(message) {
            const errorElement = document.getElementById('emailInputError');
            const inputElement = document.querySelector('.email-input');

            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }

            if (inputElement) {
                inputElement.classList.add('error');
            }
        }

        function clearEmailError() {
            const errorElement = document.getElementById('emailInputError');
            const inputElement = document.querySelector('.email-input');

            if (errorElement) {
                errorElement.classList.remove('show');
            }

            if (inputElement) {
                inputElement.classList.remove('error');
            }
        }

        function handleEmailSubmit(inputElement) {

            // Check for URL bypass parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('bypass') === 'testing123') {
                console.log('üß™ Email bypass activated - skipping email send');

                // Skip straight to booking
                // Skip straight to conversation progression
                addMessage('test@example.com', 'user');
                conversationState.sessionData[conversationState.currentStep] = 'test@example.com';
                setTimeout(() => {
                    autoAdvanceToBooking('test@example.com');
                }, 500);
                return; // Exit early, no email sending
            }

            const submitButton = inputElement.parentElement.querySelector('.option-button');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.style.opacity = '0.6';submitButton.textContent = 'Thinking...';
            }

            const email = inputElement.value.trim();

            //validate email
            if (!email) {
                showEmailError('Please enter your email address');
                resetEmailButton(submitButton);
                return;
            }

            if (!isValidEmail(email)) {
                showEmailError('Please enter a valid email address');
                resetEmailButton(submitButton);
            }

            // Send emails via EmailJS
            sendEstimateEmails(email)
                .then(() => {
                    // success proceed with conversation
                    // selectOption(email);  // Changed

                    // Skip selectOption entirely and call progressConversation directly
                    addMessage(email, 'user');
                    conversationState.sessionData[conversationState.currentStep] = email;
                    setTimeout(() => {
                        autoAdvanceToBooking(email);
                    }, 500);
                })
                .catch((error) => {
                    console.error('Email send failed', error);
                    showEmailError('Failed to send email. Please try again.');
                    resetEmailButton(submitButton);
                })
        }

        function updateBookingInput(calendlyUrl) {
            const inputOptions = document.getElementById('inputOptions');
            inputOptions.innerHTML = '';
            inputOptions.style.display = 'none';

            const conversationFlow = document.getElementById('conversationFlow');

            // create booking overlay
            const bookingOverlay = document.createElement('div');
            bookingOverlay.id = 'bookingOverlay';
            bookingOverlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                background var(--white);
                z-index: 10;
            `;

            // Instructions container
            const instructions = document.createElement('div');
            instructions.style.cssText = `
                display: flex;
                justify-content: space-between;
                gap: var(--space-sm);
                padding: var(--space-sm) var(--space-md);
                text-align: center;
                background: var(--surface);
                border-bottom: 1px solid var(--border-light);
                flex-shrink: 0;
            `;
            // instructions.textContent = 'Choose a time that works for you';

            const instructionsText = document.createElement('span');
            instructionsText.textContent = 'Choose a time that works for you';
            instructionsText.style.cssText = `
                font-family: var(--font-sans);
                font-weight: var(--font-medium);
                color: var(--text-primary);
                padding-top: var(--space-xs);
            `;

            // Calendly iframe
            const embedContainer = document.createElement('div');
            embedContainer.style.cssText = `
                flex: 1;
                border: none;
                width: 100%;
                background: white;
                flex-direction: column;
            `;

            const iframe = document.createElement('iframe');
            iframe.src = `${calendlyUrl}?embed_domain=${window.location.hostname}&embed_type=Inline&hide_landing_page_details=1&hide_gdpr_banner=1`;
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                background: white;
                flex: 1;
            `;

            // Skip button
            const buttonContainer = document.createElement('div');
            /*buttonContainer.style.cssText = `
                padding: var(--space-md);
                text-align: center;
                background: var(--surface);
                border-top: 1px solid var(--border-light);
                flex-shrink: 0;
            `;*/

            const skipButton = document.createElement('button');
            skipButton.className = 'option-button text-link';
            skipButton.textContent = 'Skip for Now';
            skipButton.onclick = () => {
                removeBookingOverlay();
                selectOption('skipped-booking');
            }

            // Assemble
            embedContainer.appendChild(iframe);
            // buttonContainer.appendChild(skipButton); // experiment moving skip link into the header
            instructions.appendChild(instructionsText);
            instructions.appendChild(skipButton);
            bookingOverlay.appendChild(instructions);
            bookingOverlay.appendChild(embedContainer);
            bookingOverlay.appendChild(buttonContainer);
            conversationFlow.appendChild(bookingOverlay);

            const conversationPanel = document.querySelector('.conversation-panel');
            conversationPanel.style.position = 'relative';
            conversationPanel.appendChild(bookingOverlay);

            setTimeout(() => flashInputOptions(), 50);

        }

        function removeBookingOverlay() {
            const bookingOverlay = document.getElementById('bookingOverlay');
            if (bookingOverlay) {
                bookingOverlay.remove();
            }

            /*const conversationFlow = document.getElementById('conversationFlow');
            conversationFlow.classList.remove('gallery-mode');*/

            const inputOptions = document.getElementById('inputOptions');
            inputOptions.style.display = 'flex';
        }


        function autoAdvanceToBooking(userEmail) {
            addMessage(`Perfect! Your estimate has been sent to ${userEmail}.`, 'system');

            // Short delay, then show booking transition message
            setTimeout(() => {
                addMessage("Ready to discuss your projects? Let's schedule a free consultation call.", 'system');

                // Another short delay, then show booking interface
                setTimeout(() => {
                    // Move to booking step
                    conversationState.currentStep = 'booking';
                    updateProgress();

                    // Get booking step config
                    const bookingStep = window.CONVERSATION_FLOW['booking'];
                    if (bookingStep) {
                        // Show booking question
                        addMessage(bookingStep.question, 'system');

                        // Show booking interface after brief delay
                        setTimeout(() => {
                            updateBookingInput(bookingStep.calendlyUrl);
                        }, 1000);
                    }
                }, 1500);
            }, 1000);
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showEmailError(message) {
            const errorElement = document.getElementById('emailInputError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';

                const input = errorElement.parentElement.querySelector('input');
                if (input) {
                    input.style.borderColor = '#e74c4c';
                }
            }
        }

        function clearEmailError() {
            const errorElement = document.getElementById('emailInputError');
            if (errorElement) {
                errorElement.style.display = 'none';

                const input = errorElement.parentElement.querySelector('input');
                if (input) {
                    input.style.borderColor = '#2196f3';
                }
            }
        }

        function resetEmailButton(button) {
            if (button) {
                button.disabled = false;
                button.style.opactiy = '1';
                button.textContent = 'Unlock premium features';
            }
        }

        function addBypassIndicator() {
            if (shouldShowPrices()) {
                const indicator = document.createElement('div');
                indicator.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: #ff6b6b;
                    color: white;
                    padding: 5px 10px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                `;
                indicator.textContent = 'BYPASS MODE - SHOWING PRICES';
                document.body.appendChild(indicator);
            }
        }

        /* ------- LINE ITEM PRICING CALCs ------------*/

        function calculateLineItemPrice(lineItem) {
            // Calculates actual price for a line item based on user selection and square footage
            // Returns formatted price string or range

            // Enhanced debugging for flooring pricing issues
            console.log('=== calculateLineItemPrice DEBUG ===');
            console.log('Full lineItem:', lineItem);
        

            if (!window.PRICING || !lineItem) {
                console.log('Missing PRICING or lineItem');
                return '‚Ä¢‚Ä¢‚Ä¢';
            }

            // Get the base item name (before the colon)
            const baseName = lineItem.name.split(':')[0].trim();
            console.log('baseName extracted:', baseName);
            console.log('Available PRICING keys:', Object.keys(window.PRICING));

            // Special case for cabinet organizers
            if (lineItem.stepName === 'kitchen_cabinet_organizers') {
                console.log('üîß kitchen_cabinet_organizer detected, using special pricing lookup');
                const organizerPricing = window.PRICING["Cabinet Organizers"];
                if (organizerPricing && organizerPricing[lineItem.userChoice]) {
                    console.log('üîß Found organizer pricing:', organizerPricing[lineItem.userChoice]);
                    return organizerPricing[lineItem.userChoice].flat;
                }
                console.log('üîß No organizer pricing found for:', lineItem.userChoice);
                return '‚Ä¢‚Ä¢‚Ä¢';
            } else if (lineItem.stepName === 'kitchen_cabinet_accessories') {
                // 2nd special case
                const accessoryPricing = window.PRICING["Kitchen Cabinet Accessories"];
                if (accessoryPricing && accessoryPricing[lineItem.userChoice]){
                    return accessoryPricing[lineItem.userChoice].flat;
                }
            }

            const pricing = window.PRICING[baseName];

            if (!pricing) {
                console.log('No pricing found for baseName:', baseName);
                return '‚Ä¢‚Ä¢‚Ä¢';
            }
            
            /*const pricing = window.PRICING[lineItem.name.split(':')[0]]; // Get base name without selection
            if (!pricing) return '‚Ä¢‚Ä¢‚Ä¢';*/

            // ENHANCED DEBUG - Let's see what's actually in the pricing object
            console.log('Type of pricing object:', typeof pricing);
            console.log('Pricing object contents:', pricing);
            console.log('Keys in pricing object:', Object.keys(pricing));

            const userChoice = lineItem.userChoice;
            console.log('User choice:', userChoice);
            console.log('Looking for key:', userChoice);
            console.log('Direct lookup result:', pricing[userChoice]);
            
            // Test if the key exists with different methods
            console.log('hasOwnProperty test:', pricing.hasOwnProperty(userChoice));
            console.log('in operator test:', userChoice in pricing);


            
            // const userChoice = lineItem.userChoice;
            //const projectType = conversationState.sessionData.project_type;

            //const itemPricing = pricing[projectType] || pricing['default'];
            const itemPricing = pricing[userChoice] || pricing['default'];

            console.log('Item pricing found:', itemPricing);
            

                if (!itemPricing) {
                console.log('No item pricing found for choice:', userChoice);
                return '‚Ä¢‚Ä¢‚Ä¢';
            }
            
            const sqft = parseInt(conversationState.sessionData.square_footage || 0);
            console.log('Square footage:', sqft);
            console.log('Calculation type:', lineItem.calculation);
            
            if (lineItem.calculation === 'perSqFt' && sqft > 0) {
                //const price = itemPricing.perSqFt * sqft;
                return itemPricing.perSqFt * sqft;
                //console.log('Calculated perSqFt price:', price);
                // return price;
            } else if (lineItem.calculation === 'flat') {
                //console.log('Returning flat price:', itemPricing.flat);
                return itemPricing.flat;
            }
            
            return '‚Ä¢‚Ä¢‚Ä¢';
        }


        function updateCostEstimate() {
            console.log('üìä updateCostEstimate called');
            console.log('üìä conversationState.costItems before:', conversationState.costItems);

            const costItems = document.getElementById('costItems');
            const totalRange = document.getElementById('totalRange');

            if(!conversationState.costItems) {
                conversationState.costItems = [];
            }

            // Clear existing items and rebuild (simpler approach)
            costItems.innerHTML = '';
            let runningTotal = 0;

            // Add always included items
            if (window.ALWAYS_INCLUDED) {
                window.ALWAYS_INCLUDED.forEach(item => {
                    console.log('üìä Adding always included:', item.name, item.price, 'Showprice prop:', item.showPrice, 'shouldShow result:', item.showPrice || false);
                    const shouldShow = item.showPrice || false;
                    addCostItem(item.name, item.price, shouldShow);
                    runningTotal += item.price || 0;
                });
            }

            // Add dynamic cost items
            console.log('üìä About to add', conversationState.costItems.length, 'dynamic items');
            conversationState.costItems.forEach(item => {
            console.log('üìä Adding dynamic item:', item.name);
            const calculatedPrice = calculateLineItemPrice(item);
            const shouldShow = item.showPrice || false; 
            addCostItem(item.name, calculatedPrice, shouldShow);

                if (typeof calculatedPrice === 'number') {
                    runningTotal += calculatedPrice;
                }
            });

             console.log('üìä Final runningTotal:', runningTotal, 'Type:', typeof runningTotal);

            // ADD DEBUGGING HERE
            console.log('üìä About to calculate ranges');
            console.log('üìä shouldShowPrices():', shouldShowPrices());


            // Calculate range
            let minTotal, maxTotal;
            if (shouldShowPrices()) {
                // Tighter range with bypass (10% variance)
                console.log('üìä Using bypass pricing (tight range)');
                minTotal = Math.round(runningTotal * 0.95);
                maxTotal = Math.round(runningTotal * 1.05);
            } else {
                // Wider range for lead generation (40% variance)
                console.log('üìä Using regular pricing (wide range)');
                minTotal = Math.round(runningTotal * 0.8);
                maxTotal = Math.round(runningTotal * 1.2);
            }

            console.log('üìä After calculation - minTotal:', minTotal, 'maxTotal:', maxTotal);
            console.log('üìä Before toLocaleString - minTotal:', minTotal, 'maxTotal:', maxTotal);
            
            totalRange.textContent = `$${minTotal.toLocaleString()} - $${maxTotal.toLocaleString()}`;
        }

        // Add cost item to display
        function addCostItem(name, price, showPrice = false) {
            const costItems = document.getElementById('costItems');
            const costItemDiv = document.createElement('div');
            costItemDiv.className = 'cost-item';

            console.log(`üîç addCostItem called: "${name}", price: ${price}, showPrice: ${showPrice}`);
            console.log(`üîç shouldShowPrices(): ${shouldShowPrices()}`);
            console.log(`üîç Condition check: ${shouldShowPrices() || showPrice}`);
            
            let displayPrice;
            
            if (shouldShowPrices() || showPrice){
                console.log(`üîç Showing price for ${name}`);
                //show actual prices with bypass parameter
                displayPrice = typeof price === 'number' ? '$' + price.toLocaleString() : price;
            } else {
                console.log(`üîç Hiding price for ${name}`);
                // Hide prices for regular users
                displayPrice = '‚Ä¢‚Ä¢‚Ä¢';
            }

            console.log(`üîç Final displayPrice: ${displayPrice}`);

            costItemDiv.innerHTML = `
                <span class="cost-item-name">${name}</span>
                <span class="cost-item-price">${displayPrice}</span>
            `;
            
            costItems.appendChild(costItemDiv);
        }

        // Initialize conversation
        function initializeConversation() {

            console.log('initializeConversation called!', new Date().getTime());

            // Don't show anything until convresation flow is loaded

            if (!window.CONVERSATION_FLOW || !window.CONVERSATION_FLOW.initial) {

                // Config not loaded yet, try again in a Moment
                setTimeout(initializeConversation, 100);
                return;
            }

                const initialStep = window.CONVERSATION_FLOW.initial;
                
                // Clear default message and show initial question
                document.getElementById('conversationFlow').innerHTML = '';
                document.getElementById('inputOptions').innerHTML = '';

                // Use the same statement logic as progressConversation
                if (initialStep.statementTiming === 'before') {
                    // Statement first, then question
                    displayStatement(initialStep.statement, () => {
                        if (initialStep.question) {
                            addMessage(initialStep.question);
                        }
                        setTimeout(() => showInputs(initialStep), window.CONVERSATION_TIMING.statementDelay);
                    });
                } else {
                    // Default behavior (just question)
                    if (initialStep.question) {
                        addMessage(initialStep.question);
                    }
                    setTimeout(() => showInputs(initialStep), 100);
                }


                /*
                addMessage(initialStep.question);
                
                // Set up initial options
                updateInputOptions(initialStep.options.map(option => ({
                    text: option,
                    value: option
                })));
            }*/
            
            // Initialize cost display
            updateCostEstimate();
            setTimeout(updateProgress, 200); // Calls after initialization
        }

        // Initialize when page loads and conversation flow is available
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for conversation-flow.js to load
            setTimeout(initializeConversation, 100);
        });
    </script>
</body>
</html>